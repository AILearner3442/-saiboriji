


<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>èµ›åšDiary</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Noto+Serif+SC:wght@300;400;600&display=swap');

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{--c:#00f5ff;--m:#ff0090;--y:#ffe600;--g:#00ff88;--dark:#030810;}
html,body{width:100%;height:100%;background:#000;overflow:hidden;font-family:'Noto Serif SC',serif;color:#fff;}

/* â”€â”€ FEED â”€â”€ */
#feed{width:100%;height:100%;overflow-y:scroll;scroll-snap-type:y mandatory;scrollbar-width:none;}
#feed::-webkit-scrollbar{display:none;}
.slide{width:100%;height:100svh;scroll-snap-align:start;position:relative;overflow:hidden;display:flex;flex-direction:column;justify-content:flex-end;}
.slide-bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:saturate(1.1);}
.slide-grain{position:absolute;inset:0;opacity:.04;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");background-size:128px;pointer-events:none;z-index:1;animation:gr .15s steps(1) infinite;}
@keyframes gr{0%{background-position:0 0}25%{background-position:50px -30px}50%{background-position:-20px 60px}75%{background-position:80px 20px}}
.slide-scan{position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.06) 3px,rgba(0,0,0,.06) 4px);pointer-events:none;z-index:2;}
.slide-vig{position:absolute;inset:0;background:radial-gradient(ellipse 120% 80% at 50% 100%,rgba(0,0,0,.92) 0%,transparent 60%),radial-gradient(ellipse 100% 60% at 50% 0%,rgba(0,0,0,.6) 0%,transparent 55%),radial-gradient(ellipse at center,transparent 30%,rgba(0,0,0,.35) 100%);pointer-events:none;z-index:3;}
.slide-border{position:absolute;inset:0;box-shadow:inset 0 0 80px rgba(0,0,0,.8),inset 0 0 8px rgba(0,0,0,.95);pointer-events:none;z-index:4;}
.slide-accent{position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--c) 30%,var(--m) 70%,transparent);opacity:.6;z-index:5;}
.slide-nophoto{position:absolute;inset:0;z-index:0;}
.slide-content{position:relative;z-index:6;padding:0 26px 110px;}
.slide-dateline{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.slide-date{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,.45);letter-spacing:3px;}

/* Title - clickable */
.slide-title{font-family:'Orbitron',monospace;font-size:22px;font-weight:900;line-height:1.15;margin-bottom:12px;text-shadow:0 0 40px rgba(0,245,255,.5),0 2px 0 rgba(0,0,0,.8),0 4px 20px rgba(0,0,0,.9);cursor:pointer;}
.slide-title:active{opacity:.7;}
.slide-title.hot{text-shadow:0 0 40px rgba(255,0,144,.7),0 2px 0 rgba(0,0,0,.8),0 4px 20px rgba(0,0,0,.9);}
.slide-quote{font-family:'Noto Serif SC',serif;font-weight:300;font-size:13px;line-height:2;color:rgba(255,255,255,.65);text-shadow:0 1px 8px rgba(0,0,0,1);margin-bottom:14px;border-left:2px solid rgba(0,245,255,.4);padding-left:12px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.slide-footer{display:flex;align-items:center;justify-content:space-between;}
.slide-tags{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
.stag{font-family:'Share Tech Mono',monospace;font-size:9px;padding:3px 9px;border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.55);letter-spacing:1px;backdrop-filter:blur(4px);background:rgba(0,0,0,.2);}

/* â”€â”€ SCORE HEARTS â”€â”€ */
.score-hearts{display:flex;align-items:center;gap:2px;}
.score-hearts span{font-size:13px;line-height:1;}
.score-num{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,.5);margin-left:4px;}

/* Edit button */
.slide-edit-btn{position:absolute;top:60px;right:18px;z-index:7;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;backdrop-filter:blur(8px);transition:all .2s;}
.slide-edit-btn:active{border-color:var(--c);box-shadow:0 0 14px rgba(0,245,255,.3);}

/* â”€â”€ COMPOSER (hidden by default, tap-to-show) â”€â”€ */
#composer{
  position:fixed;bottom:0;left:0;right:0;z-index:300;
  background:linear-gradient(180deg,rgba(3,8,16,0) 0%,rgba(3,8,16,.96) 18%);
  padding:0 0 calc(env(safe-area-inset-bottom,0px) + 12px);
  pointer-events:none;
  transform:translateY(100%);
  transition:transform .35s cubic-bezier(.22,1,.36,1),opacity .3s;
  opacity:0;
}
#composer.visible{transform:translateY(0);opacity:1;pointer-events:all;}
#composer.expanded{background:rgba(3,8,16,.97);backdrop-filter:blur(24px);}
#composer::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(0,245,255,.2) 30%,rgba(255,0,144,.2) 70%,transparent);opacity:0;transition:opacity .3s;}
#composer.expanded::before{opacity:1;}

#composer-teaser{display:flex;flex-direction:column;align-items:center;padding:10px 0 8px;pointer-events:all;}
#mic-pulse-wrap{position:relative;width:72px;height:72px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
#mic-pulse-wrap::before,#mic-pulse-wrap::after{content:'';position:absolute;border-radius:50%;border:1px solid rgba(0,245,255,.25);animation:pr 2.4s ease-out infinite;}
#mic-pulse-wrap::before{inset:-10px;animation-delay:0s;}
#mic-pulse-wrap::after{inset:-20px;animation-delay:.8s;}
@keyframes pr{0%{opacity:.5;transform:scale(1)}100%{opacity:0;transform:scale(1.4)}}

#mic-main-btn{
  width:72px;height:72px;border-radius:50%;background:rgba(3,8,16,.9);
  border:1.5px solid rgba(0,245,255,.6);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;
  font-size:28px;cursor:pointer;-webkit-user-select:none;user-select:none;touch-action:manipulation;
  box-shadow:0 0 28px rgba(0,245,255,.2),inset 0 0 20px rgba(0,245,255,.04);
  transition:all .2s;pointer-events:all;position:relative;z-index:1;
}
#mic-main-btn.recording{border-color:var(--m);background:rgba(20,0,10,.9);box-shadow:0 0 40px rgba(255,0,144,.4);animation:mr 1.2s ease infinite;}
@keyframes mr{0%{box-shadow:0 0 0 0 rgba(255,0,144,.5)}70%{box-shadow:0 0 0 22px rgba(255,0,144,0)}100%{box-shadow:0 0 0 0 rgba(255,0,144,0)}}
.mic-main-label{font-family:'Share Tech Mono',monospace;font-size:7px;color:rgba(0,245,255,.5);letter-spacing:1.5px;}
#composer-hint{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.2);letter-spacing:2px;margin-top:6px;transition:opacity .3s;}
#composer.expanded #composer-hint{opacity:0;height:0;margin:0;overflow:hidden;}

#composer-expand{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.22,1,.36,1);pointer-events:none;}
#composer.expanded #composer-expand{max-height:460px;pointer-events:all;}

/* WeChat-style composer toolbar: mic | input | send */
#comp-img-strip{display:none;}
#comp-toolbar{display:flex;align-items:center;padding:6px 10px 2px;gap:8px;}
#comp-add-btn{flex-shrink:0;width:34px;height:34px;border-radius:50%;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:300;color:rgba(255,255,255,.45);cursor:pointer;line-height:1;}
#comp-add-btn:active{border-color:var(--c);color:var(--c);}
#comp-img-thumb{width:38px;height:38px;border-radius:6px;object-fit:cover;display:none;border:1px solid rgba(0,245,255,.3);flex-shrink:0;}
#comp-score-wrap{display:flex;align-items:center;gap:3px;flex:1;}
.score-hearts-pick{display:flex;gap:1px;}
.shp{font-size:13px;cursor:pointer;opacity:.28;transition:opacity .1s;-webkit-user-select:none;user-select:none;line-height:1;}
.shp.active{opacity:1;}
#new-score-val{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.28);margin-left:2px;}
.score-picker-row{display:none;}

/* Main input row: voice mic | textarea | send â€” like WeChat */
#comp-text-row{display:flex;align-items:flex-end;gap:8px;padding:6px 10px calc(env(safe-area-inset-bottom,0px)+8px);}
#comp-voice-btn{flex-shrink:0;width:36px;height:36px;border-radius:50%;border:1px solid rgba(0,245,255,.25);background:rgba(0,245,255,.04);display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;touch-action:manipulation;}
#comp-voice-btn.recording{border-color:var(--m);background:rgba(255,0,144,.1);animation:mr 1.2s ease infinite;}
#transcript-text{flex:1;min-height:36px;max-height:96px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:18px;color:rgba(255,255,255,.88);font-family:'Noto Serif SC',serif;font-size:15px;line-height:1.6;padding:7px 14px;outline:none;resize:none;caret-color:var(--c);}
#transcript-text:focus{border-color:rgba(0,245,255,.3);}
#transcript-text::placeholder{color:rgba(255,255,255,.18);font-size:13px;}
#save-btn{flex-shrink:0;width:36px;height:36px;background:var(--c);border:none;border-radius:50%;color:var(--dark);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
#save-btn:active{box-shadow:0 0 16px rgba(0,245,255,.5);}

/* â”€â”€ TOP NAV â”€â”€ */
#top-nav{position:fixed;top:0;left:0;right:0;z-index:200;padding:max(env(safe-area-inset-top,0px),40px) 22px 14px;display:flex;justify-content:space-between;align-items:center;pointer-events:none;}
.nav-logo{font-family:'Orbitron',monospace;font-size:13px;font-weight:900;color:rgba(255,255,255,.9);letter-spacing:3px;text-shadow:0 0 20px rgba(0,245,255,.5);pointer-events:all;cursor:pointer;}
.nav-logo em{color:var(--c);font-style:normal;}
.nav-right{display:flex;align-items:center;gap:10px;pointer-events:all;}
.nav-dot{width:7px;height:7px;border-radius:50%;background:#00ff88;box-shadow:0 0 8px #00ff88;animation:br 2.5s infinite;}
@keyframes br{0%,100%{opacity:1}50%{opacity:.3}}
.nav-btn{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.35);letter-spacing:1px;cursor:pointer;padding:5px 10px;border:1px solid rgba(255,255,255,.1);transition:all .2s;}
.nav-btn:active,.nav-btn.on{border-color:var(--c);color:var(--c);}

/* â”€â”€ DOTS â”€â”€ */
#dots{position:fixed;right:8px;top:50%;transform:translateY(-50%);z-index:200;display:flex;flex-direction:column;gap:5px;}
.dot{width:2px;height:2px;border-radius:50%;background:rgba(255,255,255,.25);transition:all .3s;}
.dot.on{height:14px;border-radius:1px;background:var(--c);box-shadow:0 0 6px var(--c);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL PAGE (full-screen journal)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#detail-panel{
  position:fixed;inset:0;z-index:800;
  background:rgba(3,8,16,.98);
  backdrop-filter:blur(20px);
  display:none;flex-direction:column;
  overflow:hidden;
}
#detail-panel.show{display:flex;}
#detail-panel::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(0,245,255,.015) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,.015) 1px,transparent 1px);background-size:28px 28px;pointer-events:none;}

.dp-header{position:relative;z-index:2;padding:max(env(safe-area-inset-top,0px),48px) 20px 14px;border-bottom:1px solid rgba(0,245,255,.1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.dp-back{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.4);letter-spacing:2px;padding:8px 14px;border:1px solid rgba(255,255,255,.1);cursor:pointer;}
.dp-back:active{border-color:var(--c);color:var(--c);}
.dp-actions{display:flex;gap:8px;}
.dp-edit-btn{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,245,255,.5);letter-spacing:2px;padding:8px 12px;border:1px solid rgba(0,245,255,.2);cursor:pointer;}
.dp-edit-btn:active{background:rgba(0,245,255,.08);}

/* dp-body replaced by #dp-scroll in flex layout */

.dp-cover{width:100%;height:220px;object-fit:cover;display:block;opacity:.85;}
.dp-cover-none{width:100%;height:80px;background:linear-gradient(135deg,rgba(0,30,50,.8),rgba(0,10,20,.9));}

.dp-meta{padding:20px 22px 16px;}
.dp-date{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,.35);letter-spacing:3px;margin-bottom:8px;}
.dp-title{font-family:'Orbitron',monospace;font-size:20px;font-weight:900;line-height:1.25;margin-bottom:12px;color:#fff;}
.dp-score-row{display:flex;align-items:center;gap:8px;margin-bottom:14px;}
.dp-score-hearts{display:flex;gap:3px;}
.dp-score-hearts span{font-size:16px;}
.dp-score-label{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,.3);letter-spacing:2px;}
.dp-tags{display:flex;gap:6px;flex-wrap:wrap;}

.dp-content{padding:0 22px 20px;}
.dp-body-text{font-family:'Noto Serif SC',serif;font-size:15px;line-height:2.1;color:rgba(255,255,255,.8);white-space:pre-wrap;}

/* AI Chat in detail */
.dp-chat-section{padding:0 16px 24px;}
.dp-chat-divider{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
.dp-chat-divider::before,.dp-chat-divider::after{content:'';flex:1;height:1px;background:rgba(0,245,255,.12);}
.dp-chat-label{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,245,255,.4);letter-spacing:3px;white-space:nowrap;}

.chat-log{display:flex;flex-direction:column;gap:10px;}
.chat-msg{display:flex;flex-direction:column;gap:3px;}
.chat-msg.user{align-items:flex-end;}
.chat-msg.ai{align-items:flex-start;}
.chat-bubble{max-width:80%;padding:9px 13px;font-family:'Noto Serif SC',serif;font-size:13px;line-height:1.75;}
.chat-msg.user .chat-bubble{background:rgba(0,245,255,.12);border:1px solid rgba(0,245,255,.2);color:rgba(255,255,255,.9);border-radius:14px 14px 2px 14px;}
.chat-msg.ai .chat-bubble{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);color:rgba(255,255,255,.75);border-radius:14px 14px 14px 2px;}
.chat-time{font-family:'Share Tech Mono',monospace;font-size:8px;color:rgba(255,255,255,.2);letter-spacing:1px;}
.chat-thinking{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,0,144,.4);letter-spacing:2px;animation:blink .8s infinite;}
@keyframes blink{0%,100%{opacity:.4}50%{opacity:1}}

/* Detail panel: true flex column so input bar sits naturally at bottom */
#dp-scroll{flex:1;overflow-y:auto;overflow-x:hidden;scrollbar-width:none;-webkit-overflow-scrolling:touch;}
#dp-scroll::-webkit-scrollbar{display:none;}

/* Chat input bar â€” flex child, keyboard pushes it up naturally */
#dp-input-bar{
  flex-shrink:0;
  padding:8px 12px calc(env(safe-area-inset-bottom,0px)+6px);
  background:rgba(4,10,20,.97);
  border-top:1px solid rgba(255,255,255,.07);
  display:flex;align-items:flex-end;gap:8px;
}
#dp-chat-input{
  flex:1;min-height:36px;max-height:80px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.1);
  border-radius:18px;
  color:rgba(255,255,255,.88);font-family:'Noto Serif SC',serif;font-size:14px;line-height:1.6;
  padding:7px 14px;outline:none;resize:none;caret-color:var(--c);
}
#dp-chat-input:focus{border-color:rgba(0,245,255,.3);}
#dp-chat-input::placeholder{color:rgba(255,255,255,.18);font-size:12px;}
/* Single mic button for chat voice */
#dp-voice-btn{
  flex-shrink:0;width:36px;height:36px;border-radius:50%;
  border:1px solid rgba(0,245,255,.25);background:rgba(0,245,255,.04);
  display:flex;align-items:center;justify-content:center;
  font-size:15px;cursor:pointer;touch-action:manipulation;
}
#dp-voice-btn.recording{border-color:var(--m);background:rgba(255,0,144,.1);animation:mr 1.2s ease infinite;}
#dp-send-btn{
  flex-shrink:0;width:36px;height:36px;
  background:var(--c);border:none;border-radius:50%;
  color:var(--dark);font-size:15px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDIT PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#edit-panel{position:fixed;inset:0;z-index:850;background:rgba(3,8,16,.97);backdrop-filter:blur(20px);display:none;flex-direction:column;overflow:hidden;}
#edit-panel.show{display:flex;}
#edit-panel::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(0,245,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,.02) 1px,transparent 1px);background-size:28px 28px;pointer-events:none;}
.ep-header{position:relative;z-index:2;padding:max(env(safe-area-inset-top,0px),52px) 22px 16px;border-bottom:1px solid rgba(0,245,255,.1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.ep-title{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;color:var(--c);letter-spacing:4px;}
.ep-close{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.4);letter-spacing:2px;padding:8px 14px;border:1px solid rgba(255,255,255,.1);cursor:pointer;}
.ep-close:active{border-color:var(--m);color:var(--m);}
.ep-body{position:relative;z-index:2;flex:1;overflow-y:auto;padding:20px 22px;display:flex;flex-direction:column;gap:18px;scrollbar-width:none;}
.ep-body::-webkit-scrollbar{display:none;}
.ep-photo{width:100%;height:160px;position:relative;cursor:pointer;overflow:hidden;border:1px dashed rgba(0,245,255,.15);}
.ep-photo-img{width:100%;height:100%;object-fit:cover;display:none;}
.ep-photo-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;}
.ep-photo-lbl{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(0,245,255,.35);letter-spacing:3px;}
.ep-label{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,245,255,.4);letter-spacing:3px;margin-bottom:6px;}
.ep-title-input{width:100%;background:rgba(0,245,255,.03);border:1px solid rgba(0,245,255,.12);border-bottom:1px solid rgba(0,245,255,.25);color:rgba(255,255,255,.9);font-family:'Orbitron',monospace;font-size:18px;font-weight:700;padding:12px 14px;outline:none;letter-spacing:1px;caret-color:var(--c);}
.ep-title-input:focus{border-color:rgba(0,245,255,.4);}
.ep-body-input{width:100%;min-height:160px;background:rgba(0,245,255,.02);border:1px solid rgba(0,245,255,.1);color:rgba(255,255,255,.85);font-family:'Noto Serif SC',serif;font-size:15px;line-height:2;padding:14px;outline:none;resize:none;caret-color:var(--c);}
.ep-body-input:focus{border-color:rgba(0,245,255,.3);}
.ep-tags-input{width:100%;background:rgba(0,245,255,.02);border:1px solid rgba(0,245,255,.1);color:rgba(255,255,255,.7);font-family:'Share Tech Mono',monospace;font-size:12px;padding:10px 14px;outline:none;caret-color:var(--c);letter-spacing:1px;}
.ep-tags-hint{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.2);letter-spacing:1px;margin-top:4px;}
.ep-date-row{font-family:'Share Tech Mono',monospace;font-size:12px;color:rgba(255,255,255,.35);letter-spacing:2px;padding:10px 14px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);}
.ep-delete{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,80,80,.4);letter-spacing:2px;padding:12px;border:1px solid rgba(255,80,80,.2);text-align:center;cursor:pointer;margin-bottom:20px;}
.ep-delete:active{color:#ff5050;border-color:#ff5050;background:rgba(255,80,80,.08);}
.ep-footer{position:relative;z-index:2;flex-shrink:0;padding:14px 22px calc(env(safe-area-inset-bottom,0px) + 16px);border-top:1px solid rgba(0,245,255,.1);display:flex;gap:12px;}
.ep-save{flex:1;height:56px;background:var(--c);border:none;color:var(--dark);font-family:'Orbitron',monospace;font-size:13px;font-weight:900;letter-spacing:3px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);}
.ep-mic-small{flex-shrink:0;width:56px;height:56px;border-radius:50%;border:1.5px solid rgba(0,245,255,.4);background:rgba(0,245,255,.05);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:20px;cursor:pointer;touch-action:manipulation;}
.ep-mic-small.recording{border-color:var(--m);background:rgba(255,0,144,.1);animation:mr 1.2s ease infinite;}
.ep-mic-lbl{font-family:'Share Tech Mono',monospace;font-size:7px;color:rgba(0,245,255,.5);letter-spacing:1px;}

/* Edit score picker */
.ep-score-row{display:flex;gap:4px;flex-wrap:wrap;}
.esp{font-size:22px;cursor:pointer;opacity:.3;transition:all .15s;-webkit-user-select:none;user-select:none;}
.esp.active{opacity:1;transform:scale(1.1);}

/* â”€â”€ LISTEN OVERLAY â”€â”€ */
#listen-overlay{position:fixed;inset:0;z-index:900;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(3,8,16,.9);backdrop-filter:blur(16px);}
#listen-overlay.show{display:flex;}
.listen-ring{width:120px;height:120px;border-radius:50%;border:1.5px solid var(--m);display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:28px;}
.listen-ring::before,.listen-ring::after{content:'';position:absolute;border-radius:50%;border:1px solid var(--m);animation:rp 1.8s ease-out infinite;}
.listen-ring::before{inset:-16px;animation-delay:0s;}
.listen-ring::after{inset:-32px;animation-delay:.6s;}
@keyframes rp{0%{opacity:.6;transform:scale(1)}100%{opacity:0;transform:scale(1.3)}}
.listen-mic{font-size:40px;}
.listen-wave{display:flex;gap:4px;align-items:center;height:44px;margin-bottom:20px;}
.lw-bar{width:3px;background:var(--m);border-radius:2px;box-shadow:0 0 6px var(--m);animation:lwa .5s ease-in-out infinite alternate;}
@keyframes lwa{from{height:4px}to{height:36px}}
.listen-txt{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.5);letter-spacing:3px;margin-bottom:8px;}
.listen-interim{font-family:'Noto Serif SC',serif;font-size:15px;color:rgba(255,255,255,.8);max-width:80%;text-align:center;line-height:1.8;min-height:24px;}
.listen-stop{margin-top:28px;font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.35);letter-spacing:2px;padding:10px 24px;border:1px solid rgba(255,255,255,.15);cursor:pointer;}
.listen-stop:active{border-color:var(--c);color:var(--c);}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:999;font-family:'Share Tech Mono',monospace;font-size:11px;padding:12px 24px;background:rgba(3,8,16,.95);border:1px solid var(--c);color:var(--c);letter-spacing:2px;white-space:nowrap;display:none;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);box-shadow:0 0 20px rgba(0,245,255,.2);}

/* â”€â”€ DELETE CONFIRM â”€â”€ */
#del-confirm{position:fixed;inset:0;z-index:950;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);backdrop-filter:blur(10px);}
#del-confirm.show{display:flex;}
.del-box{background:rgba(8,16,30,.98);border:1px solid rgba(255,80,80,.3);padding:32px 28px;max-width:300px;width:90%;text-align:center;}
.del-title{font-family:'Orbitron',monospace;font-size:14px;color:#ff5050;letter-spacing:2px;margin-bottom:12px;}
.del-sub{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.4);letter-spacing:1px;margin-bottom:28px;line-height:1.8;}
.del-btns{display:flex;gap:12px;}
.del-cancel{flex:1;padding:12px;background:transparent;border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.5);font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:2px;cursor:pointer;}
.del-ok{flex:1;padding:12px;background:rgba(255,80,80,.15);border:1px solid #ff5050;color:#ff5050;font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:2px;cursor:pointer;}

input[type=file]{display:none;}

/* â”€â”€ CALENDAR â”€â”€ */
#cal-btn{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 14px);right:18px;z-index:400;width:42px;height:42px;border-radius:50%;background:rgba(3,8,16,.85);border:1px solid rgba(0,245,255,.3);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;backdrop-filter:blur(12px);}
#cal-panel{position:fixed;inset:0;z-index:850;display:none;flex-direction:column;background:rgba(3,8,16,.97);backdrop-filter:blur(24px);}
#cal-panel.show{display:flex;}
#cal-panel::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(0,245,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,.02) 1px,transparent 1px);background-size:28px 28px;pointer-events:none;}
.cal-header{position:relative;z-index:2;padding:max(env(safe-area-inset-top,0px),52px) 22px 16px;border-bottom:1px solid rgba(0,245,255,.1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.cal-title-text{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;color:var(--c);letter-spacing:4px;}
.cal-header-right{display:flex;gap:8px;align-items:center;}
.cal-filter-btn{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.3);letter-spacing:1px;padding:5px 10px;border:1px solid rgba(255,255,255,.1);cursor:pointer;transition:all .2s;}
.cal-filter-btn.on{border-color:rgba(255,150,150,.5);color:rgba(255,150,150,.8);}
.cal-filter-btn.on2{border-color:rgba(0,245,255,.5);color:rgba(0,245,255,.8);}
.cal-close{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.4);letter-spacing:2px;padding:8px 14px;border:1px solid rgba(255,255,255,.1);cursor:pointer;}
.cal-body{position:relative;z-index:2;flex:1;overflow-y:auto;padding:20px 18px;scrollbar-width:none;display:flex;flex-direction:column;gap:20px;}
.cal-body::-webkit-scrollbar{display:none;}
.cal-month-nav{display:flex;align-items:center;justify-content:space-between;gap:8px;}
.cal-nav-btn{width:38px;height:38px;border-radius:50%;border:1px solid rgba(0,245,255,.2);background:transparent;color:var(--c);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.cal-month-label{font-family:'Orbitron',monospace;font-size:16px;font-weight:700;color:rgba(255,255,255,.9);letter-spacing:2px;text-align:center;flex:1;}
.cal-grid-wrap{background:rgba(0,245,255,.02);border:1px solid rgba(0,245,255,.08);}
.cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid rgba(0,245,255,.06);}
.cal-wd{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,245,255,.35);letter-spacing:1px;text-align:center;padding:8px 0;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);}
.cal-day{min-height:44px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;transition:all .15s;gap:3px;}
.cal-day.empty{cursor:default;}
.cal-day-num{font-family:'Share Tech Mono',monospace;font-size:13px;color:rgba(255,255,255,.45);}
.cal-day.has-entry .cal-day-num{color:rgba(255,255,255,.9);}
.cal-day.today .cal-day-num{color:var(--c);}
.cal-day.selected{background:var(--c);}
.cal-day.selected .cal-day-num{color:var(--dark);font-weight:700;}
.cal-day-dot{width:4px;height:4px;border-radius:50%;background:var(--c);box-shadow:0 0 4px var(--c);}
.cal-preview{border-top:1px solid rgba(0,245,255,.08);padding-top:4px;}
.cal-preview-date{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(0,245,255,.4);letter-spacing:2px;margin-bottom:12px;}
.cal-entry-card{padding:14px;border:1px solid rgba(0,245,255,.1);background:rgba(0,245,255,.02);cursor:pointer;transition:all .2s;margin-bottom:10px;}
.cal-entry-card:active{border-color:rgba(0,245,255,.4);}
.cal-entry-title{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:rgba(255,255,255,.9);margin-bottom:6px;}
.cal-entry-body{font-family:'Noto Serif SC',serif;font-size:12px;color:rgba(255,255,255,.45);line-height:1.8;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.cal-entry-meta{display:flex;align-items:center;gap:8px;margin-top:8px;}
.cal-no-entry{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.2);letter-spacing:2px;text-align:center;padding:24px 0;}
/* Score filter list */
#score-filter-list{display:flex;flex-direction:column;gap:10px;}
.sfl-card{padding:14px;border:1px solid rgba(0,245,255,.1);background:rgba(0,245,255,.02);cursor:pointer;}
.sfl-card:active{border-color:rgba(0,245,255,.4);}
.sfl-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.sfl-title{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:rgba(255,255,255,.9);}
.sfl-hearts{display:flex;gap:2px;}
.sfl-hearts span{font-size:12px;}
.sfl-date{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.3);letter-spacing:2px;}
.sfl-body{font-family:'Noto Serif SC',serif;font-size:12px;color:rgba(255,255,255,.45);line-height:1.8;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
</style>
</head>
<body>

<!-- Top nav -->
<div id="top-nav">
  <div class="nav-logo" onclick="goFeed()">Cyber<em>//</em>Diary</div>
  <div class="nav-right">
    <div class="nav-dot"></div>
    <div class="nav-btn" onclick="openCalendar()">ğŸ“…</div>
  </div>
</div>

<div id="dots"></div>

<!-- Listen overlay -->
<div id="listen-overlay">
  <div class="listen-ring"><div class="listen-mic">ğŸ™ï¸</div></div>
  <div class="listen-wave" id="listen-wave"></div>
  <div class="listen-txt">â— æ­£åœ¨è†å¬</div>
  <div class="listen-interim" id="listen-interim">...</div>
  <div class="listen-stop" onclick="stopListen()">åœæ­¢å½•éŸ³</div>
</div>

<!-- â•â• DETAIL PANEL â•â• -->
<div id="detail-panel">
  <div class="dp-header">
    <div class="dp-back" onclick="closeDetail()">â† è¿”å›</div>
    <div class="dp-actions">
      <div class="dp-edit-btn" onclick="openEditFromDetail()">âœ ç¼–è¾‘</div>
    </div>
  </div>
  <!-- Scrollable content -->
  <div id="dp-scroll">
    <div id="dp-cover-wrap"></div>
    <div class="dp-meta">
      <div class="dp-date" id="dp-date"></div>
      <div class="dp-title" id="dp-title"></div>
      <div class="dp-score-row">
        <div class="dp-score-hearts" id="dp-score-hearts"></div>
        <div class="dp-score-label" id="dp-score-label"></div>
      </div>
      <div class="dp-tags" id="dp-tags"></div>
    </div>
    <div class="dp-content">
      <div class="dp-body-text" id="dp-body-text"></div>
    </div>
    <!-- AI Chat log -->
    <div class="dp-chat-section">
      <div class="dp-chat-divider"><span class="dp-chat-label">AI Â· å¯¹è¯è®°å½•</span></div>
      <div class="chat-log" id="chat-log"></div>
    </div>
  </div>
  <!-- Chat input bar â€” flex child, sits naturally at bottom, keyboard pushes it up -->
  <div id="dp-input-bar">
    <div id="dp-voice-btn" onclick="toggleVoiceForChat()" title="è¯­éŸ³è¾“å…¥">ğŸ™ï¸</div>
    <textarea id="dp-chat-input" rows="1" placeholder="å’Œ AI èŠèŠè¿™ç¯‡æ—¥è®°..."></textarea>
    <div id="dp-send-btn" onclick="sendChat()">â†‘</div>
  </div>
</div>

<!-- Edit panel -->
<div id="edit-panel">
  <div class="ep-header">
    <div class="ep-title">// EDIT ENTRY</div>
    <div class="ep-close" onclick="closeEdit()">âœ• å–æ¶ˆ</div>
  </div>
  <div class="ep-body" id="ep-body">
    <div>
      <div class="ep-label">// å°é¢ç…§ç‰‡</div>
      <div class="ep-photo" onclick="document.getElementById('ep-file').click()">
        <div class="ep-photo-placeholder"><div style="font-size:24px">ğŸ“·</div><div class="ep-photo-lbl">ç‚¹å‡»æ›´æ¢ç…§ç‰‡</div></div>
        <img class="ep-photo-img" id="ep-photo-img" src="" alt="">
      </div>
    </div>
    <div><div class="ep-label">// æ—¥æœŸ</div><div class="ep-date-row" id="ep-date-row"></div></div>
    <div>
      <div class="ep-label">// æ ‡é¢˜</div>
      <input class="ep-title-input" id="ep-title-input" type="text" placeholder="æ ‡é¢˜...">
    </div>
    <div>
      <div class="ep-label">// æ­£æ–‡</div>
      <textarea class="ep-body-input" id="ep-body-input" rows="7" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ..."></textarea>
    </div>
    <!-- Score picker 1-10 -->
    <div>
      <div class="ep-label">// å¿ƒæƒ…è¯„åˆ† <span id="ep-score-display" style="color:rgba(255,255,255,.6);letter-spacing:0;margin-left:6px;font-size:10px;"></span></div>
      <div class="ep-score-row" id="ep-score-row"></div>
    </div>
    <div>
      <div class="ep-label">// æ ‡ç­¾</div>
      <input class="ep-tags-input" id="ep-tags-input" type="text" placeholder="æ¼«æ¸¸ å¤œæ™š æ„Ÿæ‚Ÿ">
      <div class="ep-tags-hint">å¤šä¸ªæ ‡ç­¾ç”¨ç©ºæ ¼éš”å¼€</div>
    </div>
    <div class="ep-delete" onclick="confirmDelete()">âš  åˆ é™¤è¿™æ¡æ—¥è®°</div>
  </div>
  <div class="ep-footer">
    <div class="ep-mic-small" id="ep-mic-btn" onclick="toggleVoiceForEdit()">
      <div>ğŸ™ï¸</div>
      <div class="ep-mic-lbl" id="ep-mic-lbl">ç‚¹å‡»å½•éŸ³</div>
    </div>
    <button class="ep-save" onclick="saveEdit()">SAVE // ä¿å­˜ä¿®æ”¹</button>
  </div>
</div>

<!-- Delete confirm -->
<div id="del-confirm">
  <div class="del-box">
    <div class="del-title">DELETE ENTRY</div>
    <div class="del-sub">åˆ é™¤åæ— æ³•æ¢å¤<br>ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ</div>
    <div class="del-btns">
      <button class="del-cancel" onclick="document.getElementById('del-confirm').classList.remove('show')">å–æ¶ˆ</button>
      <button class="del-ok" onclick="doDelete()">ç¡®è®¤åˆ é™¤</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- Floating Composer (tap feed to show) -->
<div id="composer">
  <!-- Teaser: just the big mic button -->
  <div id="composer-teaser">
    <div id="mic-pulse-wrap">
      <div id="mic-main-btn" onclick="handleMicTap()">
        <div>ğŸ™ï¸</div>
        <div class="mic-main-label" id="mic-main-label"></div>
      </div>
    </div>
    <div id="composer-hint">TAP TO WRITE</div>
  </div>
  <!-- Expanded: WeChat-style layout -->
  <div id="composer-expand">
    <!-- Toolbar: + photo | score hearts -->
    <div id="comp-toolbar">
      <div id="comp-add-btn" onclick="document.getElementById('fileInput').click()" title="æ·»åŠ ç…§ç‰‡">ï¼‹</div>
      <img id="comp-img-thumb" src="" alt="">
      <div id="comp-score-wrap">
        <div class="score-hearts-pick" id="new-score-pick"></div>
        <span id="new-score-val"></span>
      </div>
    </div>
    <!-- Input row: mic | textarea | send -->
    <div id="comp-text-row">
      <div id="comp-voice-btn" onclick="toggleVoiceForNew()" title="è¯­éŸ³è¾“å…¥">ğŸ™ï¸</div>
      <textarea id="transcript-text" rows="1" placeholder="å†™ä¸‹ä»Šå¤©çš„æ€ç»ª..."></textarea>
      <button id="save-btn" onclick="saveEntry()">â†‘</button>
    </div>
  </div>
</div>

<div id="feed"></div>

<!-- Calendar panel -->
<div id="cal-panel">
  <div class="cal-header">
    <div class="cal-title-text">// CALENDAR</div>
    <div class="cal-header-right">
      <div class="cal-filter-btn" id="filter-low" onclick="toggleFilter('low')">ä½åˆ† â†“</div>
      <div class="cal-filter-btn" id="filter-high" onclick="toggleFilter('high')">é«˜åˆ† â†‘</div>
      <div class="cal-close" onclick="closeCalendar()">âœ•</div>
    </div>
  </div>
  <div class="cal-body" id="cal-body">
    <div id="score-filter-list" style="display:none;"></div>
    <div id="cal-normal-view">
      <div class="cal-month-nav">
        <button class="cal-nav-btn" onclick="calShift(-1)">â€¹</button>
        <div class="cal-month-label" id="cal-month-label"></div>
        <button class="cal-nav-btn" onclick="calShift(1)">â€º</button>
      </div>
      <div class="cal-grid-wrap">
        <div class="cal-weekdays">
          <div class="cal-wd">æ—¥</div><div class="cal-wd">ä¸€</div><div class="cal-wd">äºŒ</div>
          <div class="cal-wd">ä¸‰</div><div class="cal-wd">å››</div><div class="cal-wd">äº”</div><div class="cal-wd">å…­</div>
        </div>
        <div class="cal-days" id="cal-days"></div>
      </div>
      <div class="cal-preview" id="cal-preview"></div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" onchange="handleImg(this,'new')">
<input type="file" id="ep-file" accept="image/*" onchange="handleImg(this,'ep')">

<script>
/* â•â•â•â•â•â•â•â•â•â•â• DATA â•â•â•â•â•â•â•â•â•â•â• */
let entries = [
  {title:"äº‘å½©çš„è¯­è¨€",date:"2026.02.23",body:"å“‡å¡ï¼Œè¿™äº‘å½©ç»äº†ï¼éšæ‰‹ä¸€æ‹å°±æ˜¯å¤§ç‰‡ã€‚åŸå¸‚çš„å‘¼å¸åœ¨å…‰ä¸å½±ä¹‹é—´å‡å›ºï¼Œæ¯ä¸€ç§’éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„å­˜åœ¨ã€‚",score:8,tags:["å¤©ç©º","å‚æ™š"],img:"https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80",chats:[]},
  {title:"é•¿è¡—æ¼«è¡Œ",date:"2026.02.21",body:"å…‰çº¿æŠ˜å°„çš„ç¬é—´ï¼Œæˆ‘ä»¬æŠŠè®°å¿†ç§åœ¨èŠ±å›­é‡Œã€‚éœ“è™¹ä¸çŸ³æ¿è·¯çš„å¯¹è¯ï¼Œåªæœ‰æ·±å¤œæ‰èƒ½å¬è§ã€‚",score:7,tags:["å¤œæ™š","æ¼«æ¸¸"],img:"https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=800&q=80",chats:[]},
  {title:"DEEP FOCUS",date:"2026.02.19",body:"è¿ç»­å…­å°æ—¶çš„å¿ƒæµçŠ¶æ€ã€‚ä»£ç å°±åƒæ°´ä¸€æ ·æµæ·Œï¼Œé€»è¾‘åœ¨è„‘æµ·é‡Œè‡ªåŠ¨å±•å¼€ã€‚è¿™ç§æ„Ÿè§‰å¾ˆå°‘å‡ºç°ï¼Œè¦çæƒœã€‚",score:9,tags:["å·¥ä½œ","å¿ƒæµ"],img:"https://images.unsplash.com/photo-1518770660439-4636190af475?w=800&q=80",chats:[]},
];

try {
  const saved = localStorage.getItem('neuro_entries_v2');
  if(saved) entries = JSON.parse(saved);
} catch(e){}

function persist(){
  try { localStorage.setItem('neuro_entries_v2', JSON.stringify(entries)); } catch(e){}
}

/* â•â•â•â•â•â•â•â•â•â•â• VOICE STATE â•â•â•â•â•â•â•â•â•â•â• */
let recognition = null;
let isListening = false;
let listenTarget = 'new'; // 'new' | 'ep' | 'chat'
let finalTranscript = '';
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

/* â•â•â•â•â•â•â•â•â•â•â• SCORE HEARTS RENDER â•â•â•â•â•â•â•â•â•â•â• */
function renderHearts(score, max=10){
  let h = '';
  for(let i=1;i<=max;i++){
    if(i <= score) h += '<span>â¤ï¸</span>';
    else h += '<span style="opacity:.15">ğŸ¤</span>';
  }
  return h;
}

function scoreLabel(s){
  if(s>=9) return 'æå¥½';
  if(s>=7) return 'å¾ˆå¥½';
  if(s>=5) return 'è¿˜è¡Œ';
  if(s>=3) return 'ä¸€èˆ¬';
  return 'ä½è¿·';
}

/* â•â•â•â•â•â•â•â•â•â•â• BUILD FEED â•â•â•â•â•â•â•â•â•â•â• */
let currentMood = 5;
let imgDataUrl = null;
let newScore = 5;

function buildFeed(){
  const feed = document.getElementById('feed');
  feed.innerHTML = '';

  entries.forEach((e,i) => {
    const slide = document.createElement('div');
    slide.className = 'slide';
    slide.dataset.i = i;

    const noc = [['#001a2e','#002a4a','#00f5ff'],['#1a0010','#2e0020','#ff0090'],['#1a1000','#2e1a00','#ffe600']];
    const nc = noc[i%3];

    if(e.img){
      const bg = document.createElement('img');
      bg.className = 'slide-bg';
      bg.src = e.img;
      slide.appendChild(bg);
    } else {
      const np = document.createElement('div');
      np.className = 'slide-nophoto';
      const cv = document.createElement('canvas');
      cv.id = 'pc'+i;
      cv.style.cssText = 'width:100%;height:100%;';
      np.appendChild(cv);
      slide.appendChild(np);
    }

    const sc = e.score||5;
    // Build hearts (show max 5 for compact display, half = score/2)
    let heartsHtml = '';
    for(let h=1;h<=5;h++){
      const filled = h <= Math.round(sc/2);
      heartsHtml += `<span style="font-size:12px;${filled?'':'opacity:.2'}">${filled?'â¤ï¸':'ğŸ¤'}</span>`;
    }

    slide.innerHTML += `
      <div class="slide-grain"></div>
      <div class="slide-scan"></div>
      <div class="slide-vig"></div>
      <div class="slide-border"></div>
      <div class="slide-accent"></div>
      <div class="slide-edit-btn" onclick="openEdit(${i})">âœï¸</div>
      <div class="slide-content">
        <div class="slide-dateline">
          <div class="slide-date">${e.date}</div>
        </div>
        <div class="slide-title" onclick="openDetail(${i})">${e.title}</div>
        <div class="slide-quote">${e.body.length>30?e.body.slice(0,30)+'â€¦':e.body}</div>
        <div class="slide-footer">
          <div class="slide-tags">
            ${e.tags.map(t=>`<span class="stag">${t}</span>`).join('')}
          </div>
          <div class="score-hearts">
            ${heartsHtml}
            <span class="score-num">${sc}/10</span>
          </div>
        </div>
      </div>`;

    feed.appendChild(slide);

    if(!e.img){
      setTimeout(()=>{
        const c = document.getElementById('pc'+i);
        if(c) initParticles(c, nc[0], nc[1], nc[2]);
      },80);
    }
  });

  buildDots();
  feed.removeEventListener('scroll', onFeedScroll);
  feed.addEventListener('scroll', onFeedScroll, {passive:true});

  // Tap feed to show composer
  feed.removeEventListener('click', onFeedTap);
  feed.addEventListener('click', onFeedTap);
}

/* â•â•â•â•â•â•â•â•â•â•â• COMPOSER SHOW/HIDE â•â•â•â•â•â•â•â•â•â•â• */
let composerExpanded = false;
let composerVisible = false;
let composerHideTimer = null;

function showComposer(){
  composerVisible = true;
  document.getElementById('composer').classList.add('visible');
  clearTimeout(composerHideTimer);
  // Auto-hide after 4s if not expanded
  composerHideTimer = setTimeout(()=>{
    if(!composerExpanded) hideComposer();
  }, 4000);
}

function hideComposer(){
  if(composerExpanded) return;
  composerVisible = false;
  document.getElementById('composer').classList.remove('visible');
}

function onFeedTap(e){
  // Don't trigger if tapping on interactive elements
  if(e.target.closest('.slide-edit-btn') || e.target.closest('.slide-title')) return;
  if(composerVisible && !composerExpanded){
    hideComposer();
  } else if(!composerVisible){
    showComposer();
  }
}

function handleMicTap(){
  if(!composerExpanded){
    expandComposer();
  } else {
    // Toggle voice
    toggleVoiceForNew();
  }
}

function expandComposer(){
  composerExpanded = true;
  clearTimeout(composerHideTimer);
  document.getElementById('composer').classList.add('expanded','visible');
  composerVisible = true;
  setTimeout(()=>document.getElementById('transcript-text')?.focus(), 400);
}

function collapseComposer(){
  composerExpanded = false;
  document.getElementById('composer').classList.remove('expanded');
  document.getElementById('transcript-text')?.blur();
  hideComposer();
}

// Tap outside to collapse
document.addEventListener('touchstart', (e)=>{
  if(composerExpanded && !document.getElementById('composer').contains(e.target)){
    const txt = document.getElementById('transcript-text');
    if(!txt || !txt.value.trim()) collapseComposer();
  }
},{passive:true});

/* â•â•â•â•â•â•â•â•â•â•â• SCORE PICKERS â•â•â•â•â•â•â•â•â•â•â• */
function buildScorePicker(containerId, currentScore, onPick){
  const c = document.getElementById(containerId);
  if(!c) return;
  c.innerHTML = '';
  for(let i=1;i<=10;i++){
    const s = document.createElement('span');
    s.className = 'shp' + (i <= currentScore ? ' active' : '');
    s.textContent = i <= currentScore ? 'â¤ï¸' : 'ğŸ¤';
    s.onclick = ()=>{
      onPick(i);
      buildScorePicker(containerId, i, onPick);
    };
    c.appendChild(s);
  }
}

function buildEditScorePicker(score){
  const c = document.getElementById('ep-score-row');
  if(!c) return;
  c.innerHTML = '';
  for(let i=1;i<=10;i++){
    const s = document.createElement('span');
    s.className = 'esp' + (i <= score ? ' active' : '');
    s.textContent = i <= score ? 'â¤ï¸' : 'ğŸ¤';
    s.onclick = ()=>{
      editScore = i;
      document.getElementById('ep-score-display').textContent = `${i}/10 Â· ${scoreLabel(i)}`;
      buildEditScorePicker(i);
    };
    c.appendChild(s);
  }
}

// Init new entry score picker
buildScorePicker('new-score-pick', 5, v=>{
  newScore = v;
  document.getElementById('new-score-val').textContent = `${v}/10`;
});
newScore = 5;

/* â•â•â•â•â•â•â•â•â•â•â• PARTICLES â•â•â•â•â•â•â•â•â•â•â• */
function initParticles(canvas,dark,mid,accent){
  const par = canvas.parentElement;
  canvas.width = par.offsetWidth||window.innerWidth;
  canvas.height = par.offsetHeight||window.innerHeight;
  const ctx = canvas.getContext('2d');
  const g = ctx.createRadialGradient(canvas.width*.5,canvas.height*.4,0,canvas.width*.5,canvas.height*.6,canvas.width*.9);
  g.addColorStop(0,mid); g.addColorStop(1,dark);
  ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
  const pts = Array.from({length:80},()=>({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*1.2+.3,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,a:Math.random()*.5+.15}));
  function draw(){
    ctx.fillStyle='rgba(0,0,0,0.12)'; ctx.fillRect(0,0,canvas.width,canvas.height);
    pts.forEach(p=>{
      ctx.save(); ctx.globalAlpha=p.a; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle=accent; ctx.shadowColor=accent; ctx.shadowBlur=6; ctx.fill(); ctx.restore();
      p.x+=p.vx; p.y+=p.vy;
      if(p.x<0||p.x>canvas.width)p.vx*=-1; if(p.y<0||p.y>canvas.height)p.vy*=-1;
    });
    if(canvas.isConnected) requestAnimationFrame(draw);
  }
  draw();
}

/* â•â•â•â•â•â•â•â•â•â•â• DOTS + SCROLL â•â•â•â•â•â•â•â•â•â•â• */
function buildDots(){
  const w=document.getElementById('dots'); w.innerHTML='';
  for(let i=0;i<entries.length;i++){
    const d=document.createElement('div');
    d.className='dot'+(i===0?' on':'');
    w.appendChild(d);
  }
}

function onFeedScroll(){
  const feed=document.getElementById('feed');
  const idx=Math.round(feed.scrollTop/feed.clientHeight);
  document.querySelectorAll('.dot').forEach((d,i)=>d.classList.toggle('on',i===idx));
  // Hide composer on scroll
  if(composerVisible && !composerExpanded) hideComposer();
}

/* â•â•â•â•â•â•â•â•â•â•â• VOICE â€” FIX: use click not touchstart â•â•â•â•â•â•â•â•â•â•â• */
function initRecognition(){
  if(recognition){ try{recognition.abort();}catch(e){} recognition=null; }
  const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR) return null;
  const r = new SR();
  r.lang = 'zh-CN';
  r.continuous = !isIOS;
  r.interimResults = true;

  r.onresult = (ev)=>{
    let interim='';
    for(let i=ev.resultIndex;i<ev.results.length;i++){
      if(ev.results[i].isFinal) finalTranscript += ev.results[i][0].transcript;
      else interim += ev.results[i][0].transcript;
    }
    const el = document.getElementById('listen-interim');
    if(el) el.textContent = (finalTranscript+interim)||'...';
  };

  r.onend = ()=>{
    if(isListening && isIOS && recognition){
      try{ recognition.start(); }catch(e){}
    }
  };

  r.onerror = (ev)=>{
    if(ev.error==='not-allowed'||ev.error==='service-not-allowed'){
      isListening = false;
      commitVoice();
      showToast('âš  è¯·åœ¨æ‰‹æœºæµè§ˆå™¨è®¾ç½®ä¸­å¼€å¯éº¦å…‹é£æƒé™ï¼Œé‡æ–°æ‰“å¼€é¡µé¢åå†è¯•');
    }
    if(ev.error==='no-speech' && isIOS && isListening){
      try{ recognition.start(); }catch(e){}
    }
  };
  return r;
}

function startVoice(target){
  const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ showToast('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥'); return; }

  listenTarget = target;
  finalTranscript = '';

  // Seed with current text
  if(target==='new') finalTranscript = (document.getElementById('transcript-text')||{}).value||'';
  else if(target==='ep') finalTranscript = (document.getElementById('ep-body-input')||{}).value||'';
  else if(target==='chat') finalTranscript = (document.getElementById('dp-chat-input')||{}).value||'';

  recognition = initRecognition();
  if(!recognition) return;

  try{ recognition.start(); }catch(e){ showToast('éº¦å…‹é£å¯åŠ¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•'); return; }

  isListening = true;
  document.getElementById('listen-overlay').classList.add('show');
  document.getElementById('listen-interim').textContent = '...';

  // Animate wave
  const wv = document.getElementById('listen-wave');
  wv.innerHTML = '';
  for(let i=0;i<20;i++){
    const b=document.createElement('div'); b.className='lw-bar';
    b.style.animationDelay=(i*.06)+'s';
    b.style.animationDuration=(.35+Math.random()*.3)+'s';
    wv.appendChild(b);
  }
}

function commitVoice(){
  document.getElementById('listen-overlay').classList.remove('show');
  if(!finalTranscript.trim()) return;

  if(listenTarget==='new'){
    const el=document.getElementById('transcript-text');
    if(el) el.value = finalTranscript;
    document.getElementById('comp-voice-btn').classList.remove('recording');
  } else if(listenTarget==='ep'){
    const el=document.getElementById('ep-body-input');
    if(el) el.value = finalTranscript;
    document.getElementById('ep-mic-btn').classList.remove('recording');
    document.getElementById('ep-mic-lbl').textContent='ç‚¹å‡»å½•éŸ³';
  } else if(listenTarget==='chat'){
    const el=document.getElementById('dp-chat-input');
    if(el) el.value = finalTranscript;
    document.getElementById('dp-voice-btn').classList.remove('recording');
  }
}

function stopListen(){
  if(!isListening) return;
  isListening = false;
  if(recognition){ try{recognition.stop();}catch(e){} }
  setTimeout(commitVoice, isIOS ? 600 : 250);
}

function toggleVoiceForNew(){
  if(isListening && listenTarget==='new'){ stopListen(); return; }
  if(!composerExpanded) expandComposer();
  document.getElementById('comp-voice-btn').classList.add('recording');
  startVoice('new');
}

function toggleVoiceForEdit(){
  if(isListening && listenTarget==='ep'){ stopListen(); return; }
  document.getElementById('ep-mic-btn').classList.add('recording');
  document.getElementById('ep-mic-lbl').textContent = 'å½•éŸ³ä¸­';
  startVoice('ep');
}

function toggleVoiceForChat(){
  if(isListening && listenTarget==='chat'){ stopListen(); return; }
  document.getElementById('dp-voice-btn').classList.add('recording');
  startVoice('chat');
}

/* â•â•â•â•â•â•â•â•â•â•â• NEW ENTRY â•â•â•â•â•â•â•â•â•â•â• */
function handleImg(input, target){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=(ev)=>{
    if(target==='new'){
      imgDataUrl=ev.target.result;
      const thumb=document.getElementById('comp-img-thumb');
      if(thumb){thumb.src=imgDataUrl;thumb.style.display='block';}
      // photo thumbnail shown
    } else {
      epImgDataUrl=ev.target.result;
      const img=document.getElementById('ep-photo-img');
      if(img){img.src=epImgDataUrl;img.style.display='block';}
      const lbl=document.querySelector('.ep-photo-lbl');
      if(lbl) lbl.textContent='ç‚¹å‡»æ›´æ¢ç…§ç‰‡';
    }
  };
  reader.readAsDataURL(file);
}

function saveEntry(){
  const text=(document.getElementById('transcript-text').value||'').trim();
  if(!text){ showToast('è¯·å…ˆè¾“å…¥å†…å®¹ âœ¦'); return; }
  const now=new Date();
  const ds=`${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
  const fc=text.replace(/[ï¼Œã€‚ï¼ï¼Ÿ,.!?\n]/,'Â§').split('Â§')[0].slice(0,14);
  entries.unshift({
    title:fc||'ä»Šæ—¥è®°å½•', date:ds, body:text,
    score:newScore, tags:['æ—¥è®°'],
    img:imgDataUrl||null, chats:[]
  });
  persist();

  document.getElementById('transcript-text').value='';
  finalTranscript=''; imgDataUrl=null;
  const thumb=document.getElementById('comp-img-thumb');
  if(thumb){thumb.style.display='none';thumb.src='';}
  document.getElementById('fileInput').value='';
  newScore=5;
  buildScorePicker('new-score-pick',5,v=>{newScore=v;document.getElementById('new-score-val').textContent=`${v}/10`;});

  collapseComposer();
  buildFeed();
  showToast('âœ“ å·²å†™å…¥ç¥ç»æ—¥å¿—');
  setTimeout(()=>document.getElementById('feed').scrollTo({top:0,behavior:'smooth'}),350);
}

/* â•â•â•â•â•â•â•â•â•â•â• DETAIL PAGE â•â•â•â•â•â•â•â•â•â•â• */
let detailIdx = null;

function openDetail(idx){
  detailIdx = idx;
  const e = entries[idx];

  // Cover
  const cw = document.getElementById('dp-cover-wrap');
  if(e.img){
    cw.innerHTML = `<img class="dp-cover" src="${e.img}" alt="">`;
  } else {
    cw.innerHTML = `<div class="dp-cover-none"></div>`;
  }

  document.getElementById('dp-date').textContent = e.date;
  document.getElementById('dp-title').textContent = e.title;

  const sc = e.score||5;
  document.getElementById('dp-score-hearts').innerHTML = renderHearts(sc);
  document.getElementById('dp-score-label').textContent = `${sc}/10 Â· ${scoreLabel(sc)}`;
  document.getElementById('dp-tags').innerHTML = (e.tags||[]).map(t=>`<span class="stag">${t}</span>`).join('');
  document.getElementById('dp-body-text').textContent = e.body;

  renderChatLog(e.chats||[]);
  document.getElementById('dp-chat-input').value = '';
  document.getElementById('dp-scroll').scrollTop = 0;
  document.getElementById('detail-panel').classList.add('show');
  // Hide composer behind detail
  hideComposer();
}

function closeDetail(){
  document.getElementById('detail-panel').classList.remove('show');
  detailIdx = null;
}

function openEditFromDetail(){
  const idx = detailIdx;
  closeDetail();
  setTimeout(()=>openEdit(idx), 100);
}

function renderChatLog(chats){
  const log = document.getElementById('chat-log');
  if(!chats||!chats.length){ log.innerHTML='<div style="font-family:\'Share Tech Mono\',monospace;font-size:10px;color:rgba(255,255,255,.18);letter-spacing:2px;text-align:center;padding:16px 0;">// è¿˜æ²¡æœ‰å¯¹è¯ï¼Œå¼€å§‹èŠèŠè¿™ç¯‡æ—¥è®°å§</div>'; return; }
  log.innerHTML = chats.map(c=>`
    <div class="chat-msg ${c.role}">
      <div class="chat-bubble">${c.text}</div>
      <div class="chat-time">${c.time||''}</div>
    </div>`).join('');
  // Scroll to bottom after render
  setTimeout(()=>{ const b=document.getElementById('dp-scroll'); if(b) b.scrollTop=b.scrollHeight; },100);
}

/* â•â•â•â•â•â•â•â•â•â•â• AI CHAT â•â•â•â•â•â•â•â•â•â•â• */
async function sendChat(){
  if(detailIdx===null) return;
  const input = document.getElementById('dp-chat-input');
  const text = (input.value||'').trim();
  if(!text) return;
  input.value='';

  const e = entries[detailIdx];
  if(!e.chats) e.chats=[];

  const now = new Date();
  const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

  // Add user message
  e.chats.push({role:'user', text, time:timeStr});
  renderChatLog(e.chats);

  // Show thinking
  const log = document.getElementById('chat-log');
  const thinkEl = document.createElement('div');
  thinkEl.className='chat-msg ai';
  thinkEl.innerHTML='<div class="chat-bubble"><span class="chat-thinking">AI æ€è€ƒä¸­...</span></div>';
  log.appendChild(thinkEl);
  document.getElementById('dp-scroll').scrollTop = document.getElementById('dp-scroll').scrollHeight;

  // Build context
  const context = `è¿™æ˜¯ç”¨æˆ·çš„ä¸€ç¯‡æ—¥è®°ï¼š
æ ‡é¢˜ï¼š${e.title}
æ—¥æœŸï¼š${e.date}
å†…å®¹ï¼š${e.body}
å¿ƒæƒ…è¯„åˆ†ï¼š${e.score||5}/10`;

  const history = e.chats.slice(0,-1).map(c=>({
    role: c.role==='user'?'user':'assistant',
    content: c.text
  }));

  try{
    const res = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:600,
        system:`ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ä½“è´´çš„æ—¥è®°åŠ©ç†ã€‚ç”¨æˆ·æ­£åœ¨å’Œä½ åˆ†äº«ä»–ä»¬çš„æ—¥è®°å†…å®¹ã€‚è¯·ç”¨ç®€æ´ã€æ¸©æš–çš„ä¸­æ–‡å›åº”ï¼Œå¸®åŠ©ä»–ä»¬åæ€ã€æ„Ÿæ‚Ÿï¼Œæˆ–è€…ç»™äºˆç§¯æçš„é¼“åŠ±ã€‚å›å¤æ§åˆ¶åœ¨150å­—ä»¥å†…ã€‚\n\n${context}`,
        messages:[...history,{role:'user',content:text}]
      })
    });
    const data = await res.json();
    const reply = data.content?.[0]?.text || 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›åº”ï¼Œè¯·ç¨åå†è¯•ã€‚';
    thinkEl.remove();
    e.chats.push({role:'ai', text:reply, time:timeStr});
    persist();
    renderChatLog(e.chats);
  } catch(err){
    thinkEl.remove();
    const errMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚';
    e.chats.push({role:'ai', text:errMsg, time:timeStr});
    persist();
    renderChatLog(e.chats);
  }
}

// Enter key sends chat
document.getElementById('dp-chat-input').addEventListener('keydown',e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }
});

/* â•â•â•â•â•â•â•â•â•â•â• EDIT â•â•â•â•â•â•â•â•â•â•â• */
let editingIdx = null;
let editScore = 5;
let epImgDataUrl = null;

function openEdit(idx){
  editingIdx = idx;
  const e = entries[idx];
  document.getElementById('ep-date-row').textContent = e.date;
  document.getElementById('ep-title-input').value = e.title;
  document.getElementById('ep-body-input').value = e.body;
  document.getElementById('ep-tags-input').value = (e.tags||[]).join(' ');

  const img=document.getElementById('ep-photo-img');
  const lbl=document.querySelector('.ep-photo-lbl');
  if(e.img){
    img.src=e.img;img.style.display='block';epImgDataUrl=e.img;
    if(lbl) lbl.textContent='ç‚¹å‡»æ›´æ¢ç…§ç‰‡';
  } else {
    img.style.display='none';img.src='';epImgDataUrl=null;
    if(lbl) lbl.textContent='ç‚¹å‡»æ·»åŠ ç…§ç‰‡';
  }

  editScore = e.score||5;
  document.getElementById('ep-score-display').textContent = `${editScore}/10 Â· ${scoreLabel(editScore)}`;
  buildEditScorePicker(editScore);

  document.getElementById('ep-body').scrollTop=0;
  document.getElementById('edit-panel').classList.add('show');
}

function closeEdit(){
  document.getElementById('edit-panel').classList.remove('show');
  editingIdx=null;
  document.getElementById('ep-file').value='';
  if(isListening && listenTarget==='ep') stopListen();
}

function saveEdit(){
  if(editingIdx===null) return;
  const title=(document.getElementById('ep-title-input').value||'').trim();
  const body=(document.getElementById('ep-body-input').value||'').trim();
  const tagsRaw=(document.getElementById('ep-tags-input').value||'').trim();
  const tags=tagsRaw?tagsRaw.split(/\s+/).filter(Boolean):['æ—¥è®°'];
  if(!body){ showToast('æ­£æ–‡ä¸èƒ½ä¸ºç©º âœ¦'); return; }

  entries[editingIdx]={
    ...entries[editingIdx],
    title:title||entries[editingIdx].title,
    body, tags,
    score:editScore,
    img:epImgDataUrl||null,
  };
  persist();
  closeEdit();
  buildFeed();
  showToast('âœ“ ä¿®æ”¹å·²ä¿å­˜');
  setTimeout(()=>{
    const feed=document.getElementById('feed');
    feed.scrollTo({top:editingIdx*feed.clientHeight,behavior:'smooth'});
  },350);
}

/* â•â•â•â•â•â•â•â•â•â•â• DELETE â•â•â•â•â•â•â•â•â•â•â• */
function confirmDelete(){ document.getElementById('del-confirm').classList.add('show'); }
function doDelete(){
  document.getElementById('del-confirm').classList.remove('show');
  if(editingIdx===null) return;
  entries.splice(editingIdx,1);
  persist();
  closeEdit();
  buildFeed();
  showToast('æ—¥è®°å·²åˆ é™¤');
}

/* â•â•â•â•â•â•â•â•â•â•â• CALENDAR + SCORE FILTER â•â•â•â•â•â•â•â•â•â•â• */
let calYear=new Date().getFullYear(), calMonth=new Date().getMonth(), calSelected=null;
let activeFilter=null; // 'high' | 'low' | null

function openCalendar(){
  calYear=new Date().getFullYear(); calMonth=new Date().getMonth();
  calSelected=null; activeFilter=null;
  document.getElementById('filter-high').classList.remove('on2');
  document.getElementById('filter-low').classList.remove('on');
  document.getElementById('score-filter-list').style.display='none';
  document.getElementById('cal-normal-view').style.display='';
  renderCalendar();
  document.getElementById('cal-panel').classList.add('show');
}

function closeCalendar(){ document.getElementById('cal-panel').classList.remove('show'); }
function calShift(dir){
  calMonth+=dir;
  if(calMonth<0){calMonth=11;calYear--;}
  if(calMonth>11){calMonth=0;calYear++;}
  renderCalendar();
}

function toggleFilter(type){
  if(activeFilter===type){
    activeFilter=null;
    document.getElementById('filter-high').classList.remove('on2');
    document.getElementById('filter-low').classList.remove('on');
    document.getElementById('score-filter-list').style.display='none';
    document.getElementById('cal-normal-view').style.display='';
    return;
  }
  activeFilter=type;
  document.getElementById('filter-high').classList.toggle('on2', type==='high');
  document.getElementById('filter-low').classList.toggle('on', type==='low');
  document.getElementById('cal-normal-view').style.display='none';
  renderScoreList(type);
  document.getElementById('score-filter-list').style.display='';
}

function renderScoreList(type){
  const sorted = [...entries].sort((a,b)=>
    type==='high' ? (b.score||5)-(a.score||5) : (a.score||5)-(b.score||5)
  );
  const container=document.getElementById('score-filter-list');
  container.innerHTML = `<div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.3);letter-spacing:2px;margin-bottom:14px;">${type==='high'?'// é«˜åˆ†æ—¥è®° â†“':'// ä½åˆ†æ—¥è®° â†‘'}</div>`;
  sorted.forEach(e=>{
    const idx=entries.indexOf(e);
    const sc=e.score||5;
    let hearts='';
    for(let i=1;i<=5;i++) hearts+=`<span style="font-size:11px;${i<=Math.round(sc/2)?'':'opacity:.2'}">${i<=Math.round(sc/2)?'â¤ï¸':'ğŸ¤'}</span>`;
    const card=document.createElement('div');
    card.className='sfl-card';
    card.innerHTML=`<div class="sfl-row"><div class="sfl-title">${e.title}</div><div class="sfl-hearts">${hearts}<span style="font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,.3);margin-left:4px;">${sc}/10</span></div></div>
    <div class="sfl-date">${e.date}</div>
    <div class="sfl-body">${e.body}</div>`;
    card.onclick=()=>{ closeCalendar(); setTimeout(()=>openDetail(idx),200); };
    container.appendChild(card);
  });
}

function renderCalendar(){
  const months=['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
  document.getElementById('cal-month-label').textContent=`${calYear} Â· ${months[calMonth]}`;
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const today=new Date();
  const todayStr=`${today.getFullYear()}.${String(today.getMonth()+1).padStart(2,'0')}.${String(today.getDate()).padStart(2,'0')}`;
  const entryDates=new Set(entries.map(e=>e.date));
  const grid=document.getElementById('cal-days');
  grid.innerHTML='';
  for(let i=0;i<firstDay;i++){const c=document.createElement('div');c.className='cal-day empty';grid.appendChild(c);}
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${calYear}.${String(calMonth+1).padStart(2,'0')}.${String(d).padStart(2,'0')}`;
    const has=entryDates.has(ds), isT=ds===todayStr, isSel=ds===calSelected;
    const cell=document.createElement('div');
    cell.className='cal-day'+(has?' has-entry':'')+(isT?' today':'')+(isSel?' selected':'');
    cell.innerHTML=`<div class="cal-day-num">${d}</div>${has&&!isSel?'<div class="cal-day-dot"></div>':''}`;
    cell.onclick=()=>{ calSelected=calSelected===ds?null:ds; renderCalendar(); };
    grid.appendChild(cell);
  }
  renderCalPreview();
}

function renderCalPreview(){
  const preview=document.getElementById('cal-preview');
  if(!calSelected){preview.innerHTML='';return;}
  const dayEntries=entries.filter(e=>e.date===calSelected);
  const parts=calSelected.split('.');
  const label=`${parts[0]}å¹´${Number(parts[1])}æœˆ${Number(parts[2])}æ—¥`;
  let html=`<div class="cal-preview-date">// ${label}</div>`;
  if(!dayEntries.length){html+=`<div class="cal-no-entry">è¿™å¤©æ²¡æœ‰æ—¥è®°</div>`;}
  else{
    dayEntries.forEach(e=>{
      const idx=entries.indexOf(e);
      const sc=e.score||5;
      let hearts='';
      for(let i=1;i<=5;i++) hearts+=`<span style="font-size:11px;${i<=Math.round(sc/2)?'':'opacity:.2'}">${i<=Math.round(sc/2)?'â¤ï¸':'ğŸ¤'}</span>`;
      html+=`<div class="cal-entry-card" onclick="closeCalendar();setTimeout(()=>openDetail(${idx}),200)">
        <div class="cal-entry-title">${e.title}</div>
        <div class="cal-entry-body">${e.body}</div>
        <div class="cal-entry-meta">${hearts}<span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.3);margin-left:4px;">${sc}/10</span></div>
      </div>`;
    });
  }
  preview.innerHTML=html;
}

function goToEntry(idx){
  closeCalendar();
  setTimeout(()=>{
    const feed=document.getElementById('feed');
    feed.scrollTo({top:idx*feed.clientHeight,behavior:'smooth'});
  },300);
}

/* â•â•â•â•â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•â•â•â•â• */
function goFeed(){ document.getElementById('feed').scrollTo({top:0,behavior:'smooth'}); collapseComposer(); }

/* â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â• */
function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';
  clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',3000);
}

/* â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â• */
buildFeed();
</script>
</body>
</html>



