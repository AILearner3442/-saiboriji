


<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ËµõÂçöDiary</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Noto+Serif+SC:wght@300;400;600&display=swap');

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{--c:#00f5ff;--m:#ff0090;--y:#ffe600;--g:#00ff88;--dark:#030810;}
html,body{width:100%;height:100%;max-width:100vw;background:#000;overflow:hidden;font-family:'Noto Serif SC',serif;color:#fff;overscroll-behavior:none;}

/* ‚îÄ‚îÄ FEED ‚îÄ‚îÄ */
#feed{width:100%;height:100%;overflow-y:scroll;scroll-snap-type:y mandatory;scrollbar-width:none;}
#feed::-webkit-scrollbar{display:none;}
.slide{width:100%;height:100svh;scroll-snap-align:start;position:relative;overflow:hidden;display:flex;flex-direction:column;justify-content:flex-end;}
.slide-bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:saturate(1.1);}
.slide-grain{position:absolute;inset:0;opacity:.04;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");background-size:128px;pointer-events:none;z-index:1;animation:gr .15s steps(1) infinite;}
@keyframes gr{0%{background-position:0 0}25%{background-position:50px -30px}50%{background-position:-20px 60px}75%{background-position:80px 20px}}
.slide-scan{position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.06) 3px,rgba(0,0,0,.06) 4px);pointer-events:none;z-index:2;}
.slide-vig{position:absolute;inset:0;background:radial-gradient(ellipse 120% 80% at 50% 100%,rgba(0,0,0,.92) 0%,transparent 60%),radial-gradient(ellipse 100% 60% at 50% 0%,rgba(0,0,0,.6) 0%,transparent 55%),radial-gradient(ellipse at center,transparent 30%,rgba(0,0,0,.35) 100%);pointer-events:none;z-index:3;}
.slide-border{position:absolute;inset:0;box-shadow:inset 0 0 80px rgba(0,0,0,.8),inset 0 0 8px rgba(0,0,0,.95);pointer-events:none;z-index:4;}
.slide-accent{position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--c) 30%,var(--m) 70%,transparent);opacity:.6;z-index:5;}
.slide-nophoto{position:absolute;inset:0;z-index:0;}
.slide-content{position:relative;z-index:6;padding:0 26px 110px;}
.slide-dateline{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.slide-date{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,.45);letter-spacing:3px;}

/* Title - clickable */
.slide-title{font-family:'Orbitron',monospace;font-size:22px;font-weight:900;line-height:1.15;margin-bottom:12px;text-shadow:0 0 40px rgba(0,245,255,.5),0 2px 0 rgba(0,0,0,.8),0 4px 20px rgba(0,0,0,.9);cursor:pointer;}
.slide-title:active{opacity:.7;}
.slide-title.hot{text-shadow:0 0 40px rgba(255,0,144,.7),0 2px 0 rgba(0,0,0,.8),0 4px 20px rgba(0,0,0,.9);}
.slide-quote{font-family:'Noto Serif SC',serif;font-weight:300;font-size:13px;line-height:2;color:rgba(255,255,255,.65);text-shadow:0 1px 8px rgba(0,0,0,1);margin-bottom:14px;border-left:2px solid rgba(0,245,255,.4);padding-left:12px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.slide-footer{display:flex;align-items:center;justify-content:space-between;}
.slide-tags{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
.stag{font-family:'Share Tech Mono',monospace;font-size:9px;padding:3px 9px;border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.55);letter-spacing:1px;backdrop-filter:blur(4px);background:rgba(0,0,0,.2);}

/* ‚îÄ‚îÄ SCORE HEARTS ‚îÄ‚îÄ */
.score-hearts{display:flex;align-items:center;gap:2px;}
.score-hearts span{font-size:13px;line-height:1;}
.score-num{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,.5);margin-left:4px;}

/* Edit button */
.slide-edit-btn{display:none!important;}
.slide-edit-btn:active{border-color:var(--c);box-shadow:0 0 14px rgba(0,245,255,.3);}

/* ‚îÄ‚îÄ COMPOSER ‚îÄ‚îÄ */
#composer{
  position:fixed;bottom:0;left:0;right:0;z-index:300;
  overflow:hidden;
  pointer-events:none;
  transform:translateY(100%);
  transition:transform .38s cubic-bezier(.22,1,.36,1),opacity .3s;
  opacity:0;
}
#composer.visible{transform:translateY(0);opacity:1;pointer-events:all;}
#composer.expanded .composer-panel{background:transparent;backdrop-filter:none;}

/* Panel container */
.composer-panel{
  position:relative;
  background:transparent;
  padding-top:16px;
  padding-bottom:calc(env(safe-area-inset-bottom,0px) + 10px);
}
/* Top glowing border line ‚Äî hidden */
.composer-panel::before{content:none;}
/* Corner brackets ‚Äî hidden */
.composer-panel::after{content:none;}

/* Teaser */
#composer-teaser{display:flex;flex-direction:column;align-items:center;padding:18px 0 16px;pointer-events:all;}
#mic-pulse-wrap{position:relative;width:72px;height:72px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
#mic-pulse-wrap::before,#mic-pulse-wrap::after{
  content:'';position:absolute;border-radius:50%;
  border:1px solid rgba(0,245,255,.2);
  animation:pr 2.6s ease-out infinite;
}
#mic-pulse-wrap::before{inset:-10px;animation-delay:0s;}
#mic-pulse-wrap::after{inset:-22px;animation-delay:.9s;}
@keyframes pr{0%{opacity:.6;transform:scale(1)}100%{opacity:0;transform:scale(1.5)}}

#mic-main-btn{
  width:68px;height:68px;border-radius:50%;
  background:linear-gradient(135deg,rgba(0,15,30,.95) 0%,rgba(0,5,15,.98) 100%);
  border:1.5px solid rgba(0,245,255,.55);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;
  cursor:pointer;-webkit-user-select:none;user-select:none;touch-action:manipulation;
  box-shadow:0 0 0 1px rgba(0,245,255,.08),0 0 24px rgba(0,245,255,.18),inset 0 0 24px rgba(0,245,255,.05),0 4px 20px rgba(0,0,0,.6);
  transition:all .25s;pointer-events:all;position:relative;z-index:1;
}
#mic-main-btn:active{transform:scale(.93);box-shadow:0 0 32px rgba(0,245,255,.35),inset 0 0 28px rgba(0,245,255,.1);}
#mic-main-btn.recording{
  border-color:var(--m);
  background:linear-gradient(135deg,rgba(20,0,15,.95),rgba(10,0,8,.98));
  box-shadow:0 0 0 1px rgba(255,0,144,.12),0 0 32px rgba(255,0,144,.35),inset 0 0 20px rgba(255,0,144,.08);
  animation:mr 1.2s ease infinite;
}
#mic-main-btn.recording svg rect,
#mic-main-btn.recording svg path,
#mic-main-btn.recording svg line{stroke:rgba(255,0,144,.9);}
#mic-main-btn.recording svg circle{fill:rgba(255,0,144,.8);stroke:rgba(255,0,144,.9);}
@keyframes mr{0%{box-shadow:0 0 0 0 rgba(255,0,144,.5),inset 0 0 20px rgba(255,0,144,.08)}70%{box-shadow:0 0 0 22px rgba(255,0,144,0),inset 0 0 20px rgba(255,0,144,.08)}100%{box-shadow:0 0 0 0 rgba(255,0,144,0),inset 0 0 20px rgba(255,0,144,.08)}}
.mic-main-label{font-family:'Share Tech Mono',monospace;font-size:7px;color:rgba(0,245,255,.5);letter-spacing:1.5px;}

#composer-hint{
  font-family:'Share Tech Mono',monospace;font-size:8px;
  color:rgba(255,255,255,.18);letter-spacing:3px;margin-top:8px;
  transition:opacity .3s;display:flex;align-items:center;gap:6px;
}
#composer-hint::before,#composer-hint::after{content:'';width:16px;height:1px;background:rgba(255,255,255,.1);}
#composer.expanded #composer-hint{opacity:0;height:0;margin:0;overflow:hidden;}
#teaser-score-wrap{pointer-events:all;display:none!important;}
#composer.expanded #teaser-score-wrap{display:flex!important;}

#composer-expand{max-height:0;overflow:hidden;transition:max-height .42s cubic-bezier(.22,1,.36,1);pointer-events:none;}
#composer.expanded #composer-expand{max-height:480px;pointer-events:all;}

/* Toolbar row */
#comp-img-strip{display:none;}
#comp-toolbar{
  display:flex;align-items:center;
  margin:0 20px;
  padding:10px 0 4px;gap:10px;overflow:hidden;
  border-bottom:1px solid rgba(255,255,255,.06);
}
/* Upload button */
#comp-add-btn{
  flex-shrink:0;width:34px;height:34px;border-radius:8px;
  border:1px solid rgba(0,245,255,.25);
  background:rgba(3,10,22,.75);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  display:flex;align-items:center;justify-content:center;
  color:rgba(0,245,255,.6);cursor:pointer;position:relative;transition:all .2s;
  box-shadow:0 2px 10px rgba(0,0,0,.35);
}
#comp-add-btn::after{
  content:'';position:absolute;inset:-1px;border-radius:8px;
  background:linear-gradient(135deg,rgba(0,245,255,.15),transparent 60%);
  pointer-events:none;
}
#comp-add-btn:active{border-color:var(--c);box-shadow:0 0 14px rgba(0,245,255,.25),inset 0 0 10px rgba(0,245,255,.08);}

#comp-img-thumb{width:38px;height:38px;border-radius:6px;object-fit:cover;display:none;border:1px solid rgba(0,245,255,.3);flex-shrink:0;}

/* Score hearts */
#comp-score-wrap{display:flex;align-items:center;gap:4px;flex:1;}
.score-hearts-pick{display:flex;gap:2px;}
.shp{font-size:14px;cursor:pointer;opacity:.22;transition:opacity .15s,transform .1s;-webkit-user-select:none;user-select:none;line-height:1;}
.shp.active{opacity:1;transform:scale(1.1);}
#new-score-val{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,245,255,.3);margin-left:4px;letter-spacing:1px;}
.score-picker-row{display:none;}

/* Main input row */
#comp-text-row{
  display:flex;align-items:flex-end;gap:10px;
  margin:0 20px;
  padding:8px 0 calc(env(safe-area-inset-bottom,0px)+18px);
  overflow:hidden;
}
/* Voice mic button */
#comp-voice-btn{
  flex-shrink:0;width:36px;height:36px;border-radius:10px;
  border:1px solid rgba(0,245,255,.3);
  background:rgba(3,10,22,.75);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;touch-action:manipulation;
  box-shadow:0 2px 12px rgba(0,0,0,.4);transition:all .2s;
}
#comp-voice-btn:active{border-color:rgba(0,245,255,.6);box-shadow:0 0 12px rgba(0,245,255,.2);}
#comp-voice-btn.recording{border-color:var(--m);background:rgba(20,0,12,.8);animation:mr 1.2s ease infinite;}

/* Textarea */
#transcript-text{
  flex:1;min-width:0;min-height:38px;max-height:100px;
  background:rgba(3,10,22,.75);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:1px solid rgba(255,255,255,.14);border-radius:10px;
  color:rgba(255,255,255,.9);
  font-family:'Noto Serif SC',serif;font-size:15px;line-height:1.65;
  padding:8px 14px;outline:none;resize:none;caret-color:var(--c);
  box-shadow:0 2px 12px rgba(0,0,0,.4);
  transition:border-color .2s,box-shadow .2s;
}
#transcript-text:focus{
  border-color:rgba(0,245,255,.35);
  box-shadow:0 0 0 1px rgba(0,245,255,.1),0 2px 16px rgba(0,0,0,.5);
}
#transcript-text::placeholder{color:rgba(255,255,255,.2);font-size:13px;font-family:'Share Tech Mono',monospace;letter-spacing:1px;}

/* Send button */
#save-btn{
  flex-shrink:0;width:36px;height:36px;
  background:linear-gradient(135deg,rgba(0,245,255,.9),rgba(0,200,220,.8));
  border:none;border-radius:10px;
  color:rgba(3,8,16,.95);font-size:16px;font-weight:700;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 16px rgba(0,245,255,.3),0 2px 8px rgba(0,0,0,.5);transition:all .2s;
}
#save-btn:active{transform:scale(.9);box-shadow:0 0 28px rgba(0,245,255,.55);}

/* ‚îÄ‚îÄ TOP NAV ‚îÄ‚îÄ */
#top-nav{position:fixed;top:0;left:0;right:0;z-index:200;padding:max(env(safe-area-inset-top,0px),40px) 22px 14px;display:flex;justify-content:space-between;align-items:center;pointer-events:none;}
.nav-logo{font-family:'Orbitron',monospace;font-size:13px;font-weight:900;color:rgba(255,255,255,.9);letter-spacing:3px;text-shadow:0 0 20px rgba(0,245,255,.5);pointer-events:all;cursor:pointer;}
.nav-logo em{color:var(--c);font-style:normal;}
.nav-right{display:flex;align-items:center;gap:10px;pointer-events:all;}
.nav-dot{width:7px;height:7px;border-radius:50%;background:#00ff88;box-shadow:0 0 8px #00ff88;animation:br 2.5s infinite;}
@keyframes br{0%,100%{opacity:1}50%{opacity:.3}}
.nav-btn{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.35);letter-spacing:1px;cursor:pointer;padding:5px 10px;border:1px solid rgba(255,255,255,.1);transition:all .2s;}
.nav-btn:active,.nav-btn.on{border-color:var(--c);color:var(--c);}
.nav-icon-btn{width:34px;height:34px;border-radius:8px;border:1px solid rgba(0,245,255,.25);background:rgba(3,10,22,.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;cursor:pointer;color:rgba(0,245,255,.7);transition:all .2s;box-shadow:0 0 10px rgba(0,245,255,.08);}
.nav-icon-btn:active{border-color:var(--c);color:var(--c);box-shadow:0 0 16px rgba(0,245,255,.3);}

/* Hearts under nav logo */
#nav-hearts{position:fixed;top:calc(max(env(safe-area-inset-top,0px),40px) + 44px);left:22px;z-index:200;display:flex;align-items:center;gap:3px;pointer-events:none;}

/* ‚îÄ‚îÄ DOTS ‚îÄ‚îÄ */
#dots{position:fixed;right:8px;top:50%;transform:translateY(-50%);z-index:200;display:flex;flex-direction:column;gap:5px;}
.dot{width:2px;height:2px;border-radius:50%;background:rgba(255,255,255,.25);transition:all .3s;}
.dot.on{height:14px;border-radius:1px;background:var(--c);box-shadow:0 0 6px var(--c);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DETAIL PAGE (full-screen journal)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#detail-panel{
  position:fixed;inset:0;z-index:800;
  background:rgba(3,8,16,.98);
  backdrop-filter:blur(20px);
  display:none;flex-direction:column;
  overflow:hidden;
}
#detail-panel.show{display:flex;}
#detail-panel::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(0,245,255,.015) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,.015) 1px,transparent 1px);background-size:28px 28px;pointer-events:none;}

.dp-header{position:relative;z-index:2;padding:max(env(safe-area-inset-top,0px),48px) 20px 14px;border-bottom:1px solid rgba(0,245,255,.1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.dp-back{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.4);letter-spacing:2px;padding:8px 14px;border:1px solid rgba(255,255,255,.1);cursor:pointer;}
.dp-back:active{border-color:var(--c);color:var(--c);}
.dp-actions{display:flex;gap:8px;}
.dp-edit-btn{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,245,255,.5);letter-spacing:2px;padding:8px 12px;border:1px solid rgba(0,245,255,.2);cursor:pointer;}
.dp-edit-btn:active{background:rgba(0,245,255,.08);}

/* dp-body replaced by #dp-scroll in flex layout */

.dp-cover{width:100%;height:220px;object-fit:cover;display:block;opacity:.85;}
.dp-cover-none{width:100%;height:80px;background:linear-gradient(135deg,rgba(0,30,50,.8),rgba(0,10,20,.9));}

.dp-meta{padding:20px 22px 16px;}
.dp-date{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,.35);letter-spacing:3px;margin-bottom:8px;}
.dp-title{font-family:'Orbitron',monospace;font-size:20px;font-weight:900;line-height:1.25;margin-bottom:12px;color:#fff;}
.dp-score-row{display:flex;align-items:center;gap:8px;margin-bottom:14px;}
.dp-score-hearts{display:flex;gap:3px;}
.dp-score-hearts span{font-size:16px;}
.dp-score-label{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,.3);letter-spacing:2px;}
.dp-tags{display:flex;gap:6px;flex-wrap:wrap;}

.dp-content{padding:0 22px 20px;}
.dp-body-text{font-family:'Noto Serif SC',serif;font-size:15px;line-height:2.1;color:rgba(255,255,255,.8);white-space:pre-wrap;}

/* AI Chat in detail */
.dp-chat-section{padding:0 16px 24px;}
.dp-chat-divider{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
.dp-chat-divider::before,.dp-chat-divider::after{content:'';flex:1;height:1px;background:rgba(0,245,255,.12);}
.dp-chat-label{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,245,255,.4);letter-spacing:3px;white-space:nowrap;}

.chat-log{display:flex;flex-direction:column;gap:10px;}
.chat-msg{display:flex;flex-direction:column;gap:3px;}
.chat-msg.user{align-items:flex-end;}
.chat-msg.ai{align-items:flex-start;}
.chat-bubble{max-width:80%;padding:9px 13px;font-family:'Noto Serif SC',serif;font-size:13px;line-height:1.75;}
.chat-msg.user .chat-bubble{background:rgba(0,245,255,.12);border:1px solid rgba(0,245,255,.2);color:rgba(255,255,255,.9);border-radius:14px 14px 2px 14px;}
.chat-msg.ai .chat-bubble{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);color:rgba(255,255,255,.75);border-radius:14px 14px 14px 2px;}
.chat-time{font-family:'Share Tech Mono',monospace;font-size:8px;color:rgba(255,255,255,.2);letter-spacing:1px;}
.chat-thinking{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,0,144,.4);letter-spacing:2px;animation:blink .8s infinite;}
@keyframes blink{0%,100%{opacity:.4}50%{opacity:1}}

/* Detail panel: true flex column so input bar sits naturally at bottom */
#dp-scroll{flex:1;overflow-y:auto;overflow-x:hidden;scrollbar-width:none;-webkit-overflow-scrolling:touch;padding-bottom:90px;}
#dp-scroll::-webkit-scrollbar{display:none;}

/* Chat input bar ‚Äî floats over content, no background */
#dp-input-bar{
  position:absolute;bottom:0;left:0;right:0;z-index:10;
  display:flex;align-items:flex-end;gap:10px;
  margin:0 20px;
  padding:8px 0 calc(env(safe-area-inset-bottom,0px)+18px);
  background:none;
  border-top:none;
}
#dp-chat-input{
  flex:1;min-width:0;min-height:38px;max-height:100px;
  background:rgba(3,10,22,.75);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:1px solid rgba(255,255,255,.14);border-radius:10px;
  color:rgba(255,255,255,.9);
  font-family:'Noto Serif SC',serif;font-size:15px;line-height:1.65;
  padding:8px 14px;outline:none;resize:none;caret-color:var(--c);
  box-shadow:0 2px 12px rgba(0,0,0,.4);
  transition:border-color .2s,box-shadow .2s;
}
#dp-chat-input:focus{border-color:rgba(0,245,255,.35);box-shadow:0 0 0 1px rgba(0,245,255,.1),0 2px 16px rgba(0,0,0,.5);}
#dp-chat-input::placeholder{color:rgba(255,255,255,.2);font-size:13px;font-family:'Share Tech Mono',monospace;letter-spacing:1px;}
/* Mic button ‚Äî matches comp-voice-btn */
#dp-voice-btn{
  flex-shrink:0;width:36px;height:36px;border-radius:10px;
  border:1px solid rgba(0,245,255,.3);
  background:rgba(3,10,22,.75);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;touch-action:manipulation;
  box-shadow:0 2px 12px rgba(0,0,0,.4);transition:all .2s;
}
#dp-voice-btn:active{border-color:rgba(0,245,255,.6);box-shadow:0 0 12px rgba(0,245,255,.2);}
#dp-voice-btn.recording{border-color:var(--m);background:rgba(20,0,12,.8);animation:mr 1.2s ease infinite;}
/* Send button ‚Äî matches save-btn */
#dp-send-btn{
  flex-shrink:0;width:36px;height:36px;
  background:linear-gradient(135deg,rgba(0,245,255,.9),rgba(0,200,220,.8));
  border:none;border-radius:10px;
  color:rgba(3,8,16,.95);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 16px rgba(0,245,255,.3),0 2px 8px rgba(0,0,0,.5);transition:all .2s;
}
#dp-send-btn:active{transform:scale(.9);box-shadow:0 0 28px rgba(0,245,255,.55);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EDIT PANEL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#edit-panel{position:fixed;inset:0;z-index:850;background:rgba(3,8,16,.97);backdrop-filter:blur(20px);display:none;flex-direction:column;overflow:hidden;}
#edit-panel.show{display:flex;}
#edit-panel::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(0,245,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,.02) 1px,transparent 1px);background-size:28px 28px;pointer-events:none;}
.ep-header{position:relative;z-index:2;padding:max(env(safe-area-inset-top,0px),52px) 22px 16px;border-bottom:1px solid rgba(0,245,255,.1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.ep-title{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;color:var(--c);letter-spacing:4px;}
.ep-close{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.4);letter-spacing:2px;padding:8px 14px;border:1px solid rgba(255,255,255,.1);cursor:pointer;}
.ep-close:active{border-color:var(--m);color:var(--m);}
.ep-body{position:relative;z-index:2;flex:1;overflow-y:auto;padding:20px 22px;display:flex;flex-direction:column;gap:18px;scrollbar-width:none;}
.ep-body::-webkit-scrollbar{display:none;}
.ep-photo{width:100%;height:160px;position:relative;cursor:pointer;overflow:hidden;border:1px dashed rgba(0,245,255,.15);}
.ep-photo-img{width:100%;height:100%;object-fit:cover;display:none;}
.ep-photo-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;}
.ep-photo-lbl{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(0,245,255,.35);letter-spacing:3px;}
.ep-label{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,245,255,.4);letter-spacing:3px;margin-bottom:6px;}
.ep-title-input{width:100%;background:rgba(0,245,255,.03);border:1px solid rgba(0,245,255,.12);border-bottom:1px solid rgba(0,245,255,.25);color:rgba(255,255,255,.9);font-family:'Orbitron',monospace;font-size:18px;font-weight:700;padding:12px 14px;outline:none;letter-spacing:1px;caret-color:var(--c);}
.ep-title-input:focus{border-color:rgba(0,245,255,.4);}
.ep-body-input{width:100%;min-height:160px;background:rgba(0,245,255,.02);border:1px solid rgba(0,245,255,.1);color:rgba(255,255,255,.85);font-family:'Noto Serif SC',serif;font-size:15px;line-height:2;padding:14px;outline:none;resize:none;caret-color:var(--c);}
.ep-body-input:focus{border-color:rgba(0,245,255,.3);}
.ep-tags-input{width:100%;background:rgba(0,245,255,.02);border:1px solid rgba(0,245,255,.1);color:rgba(255,255,255,.7);font-family:'Share Tech Mono',monospace;font-size:12px;padding:10px 14px;outline:none;caret-color:var(--c);letter-spacing:1px;}
.ep-tags-hint{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.2);letter-spacing:1px;margin-top:4px;}
.ep-date-row{font-family:'Share Tech Mono',monospace;font-size:12px;color:rgba(255,255,255,.35);letter-spacing:2px;padding:10px 14px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);}
.ep-delete{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,80,80,.4);letter-spacing:2px;padding:12px;border:1px solid rgba(255,80,80,.2);text-align:center;cursor:pointer;margin-bottom:20px;}
.ep-delete:active{color:#ff5050;border-color:#ff5050;background:rgba(255,80,80,.08);}
.ep-footer{position:relative;z-index:2;flex-shrink:0;padding:14px 22px calc(env(safe-area-inset-bottom,0px) + 16px);border-top:1px solid rgba(0,245,255,.1);display:flex;gap:10px;justify-content:center;align-items:center;}
.ep-mic-small{flex-shrink:0;width:40px;height:40px;border:none;background:transparent;padding:0;cursor:pointer;touch-action:manipulation;display:flex;align-items:center;justify-content:center;}
.ep-mic-small svg .mic-ring{transition:stroke .2s;}
.ep-mic-small.recording .mic-ring{stroke:var(--m);}
.ep-mic-small.recording .mic-body{stroke:var(--m);}
.ep-mic-small.recording{animation:mr 1.2s ease infinite;}
.ep-mic-lbl{display:none;}
.ep-save{height:40px;padding:0 24px;background:transparent;border:none;color:var(--dark);font-family:'Orbitron',monospace;font-size:11px;font-weight:900;letter-spacing:3px;cursor:pointer;position:relative;display:flex;align-items:center;justify-content:center;}
.ep-save:active{opacity:.75;}

/* Edit score picker */
.ep-score-row{display:flex;gap:4px;flex-wrap:wrap;}
.esp{font-size:22px;cursor:pointer;opacity:.3;transition:all .15s;-webkit-user-select:none;user-select:none;}
.esp.active{opacity:1;transform:scale(1.1);}

/* ‚îÄ‚îÄ LISTEN OVERLAY ‚îÄ‚îÄ */
#listen-overlay{
  position:fixed;inset:0;z-index:900;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:rgba(3,8,16,.92);backdrop-filter:blur(16px);
  visibility:hidden;opacity:0;pointer-events:none;
  transition:opacity .25s,visibility .25s;
}
#listen-overlay.show{visibility:visible;opacity:1;pointer-events:all;}
.listen-ring{width:120px;height:120px;border-radius:50%;border:1.5px solid var(--m);display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:28px;}
.listen-ring::before,.listen-ring::after{content:'';position:absolute;border-radius:50%;border:1px solid var(--m);animation:rp 1.8s ease-out infinite;}
.listen-ring::before{inset:-16px;animation-delay:0s;}
.listen-ring::after{inset:-32px;animation-delay:.6s;}
@keyframes rp{0%{opacity:.6;transform:scale(1)}100%{opacity:0;transform:scale(1.3)}}
.listen-mic{font-size:40px;}
.listen-wave{display:flex;gap:4px;align-items:center;height:44px;margin-bottom:20px;}
.lw-bar{width:3px;background:var(--m);border-radius:2px;box-shadow:0 0 6px var(--m);animation:lwa .5s ease-in-out infinite alternate;}
@keyframes lwa{from{height:4px}to{height:36px}}
.listen-txt{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.5);letter-spacing:3px;margin-bottom:8px;}
.listen-interim{font-family:'Noto Serif SC',serif;font-size:15px;color:rgba(255,255,255,.8);max-width:80%;text-align:center;line-height:1.8;min-height:24px;}
.listen-stop{margin-top:28px;font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.35);letter-spacing:2px;padding:10px 24px;border:1px solid rgba(255,255,255,.15);cursor:pointer;}
.listen-stop:active{border-color:var(--c);color:var(--c);}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:999;font-family:'Share Tech Mono',monospace;font-size:11px;padding:12px 24px;background:rgba(3,8,16,.95);border:1px solid var(--c);color:var(--c);letter-spacing:2px;white-space:nowrap;display:none;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);box-shadow:0 0 20px rgba(0,245,255,.2);}

/* ‚îÄ‚îÄ DELETE CONFIRM ‚îÄ‚îÄ */
#del-confirm{position:fixed;inset:0;z-index:950;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);backdrop-filter:blur(10px);}
#del-confirm.show{display:flex;}
.del-box{background:rgba(8,16,30,.98);border:1px solid rgba(255,80,80,.3);padding:32px 28px;max-width:300px;width:90%;text-align:center;}
.del-title{font-family:'Orbitron',monospace;font-size:14px;color:#ff5050;letter-spacing:2px;margin-bottom:12px;}
.del-sub{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.4);letter-spacing:1px;margin-bottom:28px;line-height:1.8;}
.del-btns{display:flex;gap:12px;}
.del-cancel{flex:1;padding:12px;background:transparent;border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.5);font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:2px;cursor:pointer;}
.del-ok{flex:1;padding:12px;background:rgba(255,80,80,.15);border:1px solid #ff5050;color:#ff5050;font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:2px;cursor:pointer;}

input[type=file]{display:none;}

/* ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ */
#cal-btn{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 14px);right:18px;z-index:400;width:42px;height:42px;border-radius:50%;background:rgba(3,8,16,.85);border:1px solid rgba(0,245,255,.3);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;backdrop-filter:blur(12px);}
#cal-panel{position:fixed;inset:0;z-index:850;display:none;flex-direction:column;background:rgba(3,8,16,.97);backdrop-filter:blur(24px);}
#cal-panel.show{display:flex;}
#cal-panel::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(0,245,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,.02) 1px,transparent 1px);background-size:28px 28px;pointer-events:none;}
.cal-header{position:relative;z-index:2;padding:max(env(safe-area-inset-top,0px),52px) 22px 16px;border-bottom:1px solid rgba(0,245,255,.1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.cal-title-text{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;color:var(--c);letter-spacing:4px;}
.cal-header-right{display:flex;gap:8px;align-items:center;}
.cal-filter-btn{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.3);letter-spacing:1px;padding:5px 10px;border:1px solid rgba(255,255,255,.1);cursor:pointer;transition:all .2s;}
.cal-filter-btn.on{border-color:rgba(255,0,150,.5);color:rgba(255,150,150,.8);}
.cal-filter-btn.on2{border-color:rgba(0,245,255,.5);color:rgba(0,245,255,.8);}
.cal-close{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.4);letter-spacing:2px;padding:8px 14px;border:1px solid rgba(255,255,255,.1);cursor:pointer;}
.cal-body{position:relative;z-index:2;flex:1;overflow-y:auto;padding:20px 18px;scrollbar-width:none;display:flex;flex-direction:column;gap:20px;}
.cal-body::-webkit-scrollbar{display:none;}
.cal-month-nav{display:flex;align-items:center;justify-content:space-between;gap:8px;}
.cal-nav-btn{width:38px;height:38px;border-radius:50%;border:1px solid rgba(0,245,255,.2);background:transparent;color:var(--c);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.cal-month-label{font-family:'Orbitron',monospace;font-size:16px;font-weight:700;color:rgba(255,255,255,.9);letter-spacing:2px;text-align:center;flex:1;}
.cal-grid-wrap{background:rgba(0,245,255,.02);border:1px solid rgba(0,245,255,.08);}
.cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid rgba(0,245,255,.06);}
.cal-wd{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,245,255,.35);letter-spacing:1px;text-align:center;padding:8px 0;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);}
.cal-day{min-height:44px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;transition:all .15s;gap:3px;}
.cal-day.empty{cursor:default;}
.cal-day-num{font-family:'Share Tech Mono',monospace;font-size:13px;color:rgba(255,255,255,.45);}
.cal-day.has-entry .cal-day-num{color:rgba(255,255,255,.9);}
.cal-day.today .cal-day-num{color:var(--c);}
.cal-day.selected{background:var(--c);}
.cal-day.selected .cal-day-num{color:var(--dark);font-weight:700;}
.cal-day-dot{width:4px;height:4px;border-radius:50%;background:var(--c);box-shadow:0 0 4px var(--c);}
.cal-preview{border-top:1px solid rgba(0,245,255,.08);padding-top:4px;}
.cal-preview-date{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(0,245,255,.4);letter-spacing:2px;margin-bottom:12px;}
.cal-entry-card{padding:14px;border:1px solid rgba(0,245,255,.1);background:rgba(0,245,255,.02);cursor:pointer;transition:all .2s;margin-bottom:10px;}
.cal-entry-card:active{border-color:rgba(0,245,255,.4);}
.cal-entry-title{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:rgba(255,255,255,.9);margin-bottom:6px;}
.cal-entry-body{font-family:'Noto Serif SC',serif;font-size:12px;color:rgba(255,255,255,.45);line-height:1.8;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.cal-entry-meta{display:flex;align-items:center;gap:8px;margin-top:8px;}
.cal-no-entry{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.2);letter-spacing:2px;text-align:center;padding:24px 0;}
/* Score filter list */
#score-filter-list{display:flex;flex-direction:column;gap:10px;}
.sfl-card{padding:14px;border:1px solid rgba(0,245,255,.1);background:rgba(0,245,255,.02);cursor:pointer;}
.sfl-card:active{border-color:rgba(0,245,255,.4);}
.sfl-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.sfl-title{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:rgba(255,255,255,.9);}
.sfl-hearts{display:flex;gap:2px;}
.sfl-hearts span{font-size:12px;}
.sfl-date{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.3);letter-spacing:2px;}
.sfl-body{font-family:'Noto Serif SC',serif;font-size:12px;color:rgba(255,255,255,.45);line-height:1.8;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
</style>
</head>
<body>


<!-- Top nav -->
<div id="top-nav">
  <div class="nav-logo" onclick="goFeed()">Cyber<em>//</em>Diary</div>
  <div class="nav-right">
    <div class="nav-dot"></div>
    <div class="nav-icon-btn" id="nav-edit-btn" onclick="" title="ÁºñËæë" style="display:none;">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M11.5 2.5L13.5 4.5L5.5 12.5H3.5V10.5L11.5 2.5Z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M9.5 4.5L11.5 6.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
        <path d="M2.5 13.5H13.5" stroke="currentColor" stroke-width="1.1" stroke-linecap="round" stroke-opacity="0.4"/>
      </svg>
    </div>
    <div class="nav-icon-btn" onclick="openCalendar()" title="Êó•ÂéÜ">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="1.5" y="3" width="13" height="11.5" rx="1.5" stroke="currentColor" stroke-width="1.3"/>
        <path d="M1.5 6.5H14.5" stroke="currentColor" stroke-width="1.1" stroke-opacity="0.5"/>
        <path d="M5 1.5V4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
        <path d="M11 1.5V4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
        <circle cx="5.5" cy="9.5" r="0.8" fill="currentColor"/>
        <circle cx="8" cy="9.5" r="0.8" fill="currentColor"/>
        <circle cx="10.5" cy="9.5" r="0.8" fill="currentColor"/>
        <circle cx="5.5" cy="12" r="0.8" fill="currentColor"/>
        <circle cx="8" cy="12" r="0.8" fill="currentColor"/>
      </svg>
    </div>
  </div>
</div>

<!-- Fixed hearts under nav -->
<div id="nav-hearts"></div>

<div id="dots"></div>

<!-- Listen overlay -->
<div id="listen-overlay">
  <div class="listen-ring"><div class="listen-mic">üéôÔ∏è</div></div>
  <div class="listen-wave" id="listen-wave"></div>
  <div class="listen-txt">‚óè Ê≠£Âú®ËÅÜÂê¨</div>
  <div class="listen-interim" id="listen-interim">...</div>
  <div class="listen-stop" onclick="stopListen()">ÂÅúÊ≠¢ÂΩïÈü≥</div>
</div>

<!-- ‚ïê‚ïê DETAIL PANEL ‚ïê‚ïê -->
<div id="detail-panel">
  <div class="dp-header">
    <div class="dp-back" onclick="closeDetail()">‚Üê ËøîÂõû</div>
    <div class="dp-actions">
      <div class="dp-edit-btn" onclick="openEditFromDetail()">‚úè ÁºñËæë</div>
    </div>
  </div>
  <!-- Scrollable content -->
  <div id="dp-scroll">
    <div id="dp-cover-wrap"></div>
    <div class="dp-meta">
      <div class="dp-date" id="dp-date"></div>
      <div class="dp-title" id="dp-title"></div>
      <div class="dp-score-row">
        <div class="dp-score-hearts" id="dp-score-hearts"></div>
        <div class="dp-score-label" id="dp-score-label"></div>
      </div>
      <div class="dp-tags" id="dp-tags"></div>
    </div>
    <div class="dp-content">
      <div class="dp-body-text" id="dp-body-text"></div>
    </div>
    <!-- AI Chat log -->
    <div class="dp-chat-section">
      <div class="dp-chat-divider"><span class="dp-chat-label">AI ¬∑ ÂØπËØùËÆ∞ÂΩï</span></div>
      <div class="chat-log" id="chat-log"></div>
    </div>
  </div>
  <!-- Chat input bar ‚Äî absolutely positioned, floats over content -->
  <div id="dp-input-bar">
    <div id="dp-voice-btn" onclick="toggleVoiceForChat()" title="ËØ≠Èü≥ËæìÂÖ•">
      <svg width="14" height="18" viewBox="0 0 14 18" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="3.5" y="0.5" width="7" height="10" rx="3.5" stroke="rgba(0,245,255,.8)" stroke-width="1.2"/>
        <path d="M1 9C1 12.314 3.686 15 7 15C10.314 15 13 12.314 13 9" stroke="rgba(0,245,255,.8)" stroke-width="1.2" stroke-linecap="round"/>
        <line x1="7" y1="15" x2="7" y2="17.5" stroke="rgba(0,245,255,.8)" stroke-width="1.2" stroke-linecap="round"/>
        <line x1="4.5" y1="17.5" x2="9.5" y2="17.5" stroke="rgba(0,245,255,.8)" stroke-width="1.3" stroke-linecap="round"/>
      </svg>
    </div>
    <textarea id="dp-chat-input" rows="1" placeholder="Âíå AI ËÅäËÅäËøôÁØáÊó•ËÆ∞..."></textarea>
    <div id="dp-send-btn" onclick="sendChat()">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M8 13V3M8 3L4 7M8 3L12 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>
</div>

<!-- Edit panel -->
<div id="edit-panel">
  <div class="ep-header">
    <div class="ep-title">// EDIT ENTRY</div>
    <div class="ep-close" onclick="closeEdit()">‚úï ÂèñÊ∂à</div>
  </div>
  <div class="ep-body" id="ep-body">
    <div>
      <div class="ep-label">// Â∞ÅÈù¢ÁÖßÁâá</div>
      <div class="ep-photo" onclick="document.getElementById('ep-file').click()">
        <div class="ep-photo-placeholder"><div style="font-size:24px">üì∑</div><div class="ep-photo-lbl">ÁÇπÂáªÊõ¥Êç¢ÁÖßÁâá</div></div>
        <img class="ep-photo-img" id="ep-photo-img" src="" alt="">
      </div>
    </div>
    <div><div class="ep-label">// Êó•Êúü</div><div class="ep-date-row" id="ep-date-row"></div></div>
    <div>
      <div class="ep-label">// Ê†áÈ¢ò</div>
      <input class="ep-title-input" id="ep-title-input" type="text" placeholder="Ê†áÈ¢ò...">
    </div>
    <div>
      <div class="ep-label">// Ê≠£Êñá</div>
      <textarea class="ep-body-input" id="ep-body-input" rows="7" placeholder="‰ªäÂ§©ÂèëÁîü‰∫Ü‰ªÄ‰πà..."></textarea>
    </div>
    <!-- Score picker 1-10 -->
    <div>
      <div class="ep-label">// ÂøÉÊÉÖËØÑÂàÜ <span id="ep-score-display" style="color:rgba(255,255,255,.6);letter-spacing:0;margin-left:6px;font-size:10px;"></span></div>
      <div class="ep-score-row" id="ep-score-row"></div>
    </div>
    <div>
      <div class="ep-label">// Ê†áÁ≠æ</div>
      <input class="ep-tags-input" id="ep-tags-input" type="text" placeholder="Êº´Ê∏∏ Â§úÊôö ÊÑüÊÇü">
      <div class="ep-tags-hint">Â§ö‰∏™Ê†áÁ≠æÁî®Á©∫Ê†ºÈöîÂºÄ</div>
    </div>
    <div class="ep-delete" onclick="confirmDelete()">‚ö† Âà†Èô§ËøôÊù°Êó•ËÆ∞</div>
  </div>
  <div class="ep-footer">
    <div class="ep-mic-small" id="ep-mic-btn" onclick="toggleVoiceForEdit()">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle class="mic-ring" cx="20" cy="20" r="18" stroke="rgba(0,245,255,0.4)" stroke-width="1.2" fill="rgba(0,245,255,0.04)"/>
        <rect class="mic-body" x="16" y="10" width="8" height="13" rx="4" stroke="rgba(0,245,255,0.85)" stroke-width="1.3" fill="none"/>
        <path class="mic-body" d="M13 21c0 3.9 3.1 7 7 7s7-3.1 7-7" stroke="rgba(0,245,255,0.85)" stroke-width="1.3" stroke-linecap="round" fill="none"/>
        <line class="mic-body" x1="20" y1="28" x2="20" y2="31" stroke="rgba(0,245,255,0.85)" stroke-width="1.3" stroke-linecap="round"/>
        <line class="mic-body" x1="16" y1="31" x2="24" y2="31" stroke="rgba(0,245,255,0.85)" stroke-width="1.3" stroke-linecap="round"/>
      </svg>
      <div class="ep-mic-lbl" id="ep-mic-lbl">ÁÇπÂáªÂΩïÈü≥</div>
    </div>
    <button class="ep-save" onclick="saveEdit()">
      <svg style="position:absolute;inset:0;width:100%;height:100%;" viewBox="0 0 120 40" preserveAspectRatio="none" fill="none" xmlns="http://www.w3.org/2000/svg">
        <polygon points="6,0 120,0 114,40 0,40" fill="rgba(0,245,255,0.9)"/>
        <line x1="6" y1="1" x2="120" y2="1" stroke="rgba(255,255,255,0.25)" stroke-width="0.8"/>
      </svg>
      <span style="position:relative;z-index:1;color:rgba(3,8,16,0.88);">SAVE</span>
    </button>
  </div>
</div>

<!-- Delete confirm -->
<div id="del-confirm">
  <div class="del-box">
    <div class="del-title">DELETE ENTRY</div>
    <div class="del-sub">Âà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§ç<br>Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Êó•ËÆ∞ÂêóÔºü</div>
    <div class="del-btns">
      <button class="del-cancel" onclick="document.getElementById('del-confirm').classList.remove('show')">ÂèñÊ∂à</button>
      <button class="del-ok" onclick="doDelete()">Á°ÆËÆ§Âà†Èô§</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- Floating Composer (tap feed to show) -->
<div id="composer">
  <div class="composer-panel">
    <!-- Teaser: big mic button -->
    <div id="composer-teaser">
      <div id="mic-pulse-wrap">
        <div id="mic-main-btn" onclick="handleMicTap()">
          <svg width="28" height="32" viewBox="0 0 28 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="9" y="1" width="10" height="17" rx="5" fill="rgba(0,245,255,.06)" stroke="rgba(0,245,255,.9)" stroke-width="1.6"/>
            <line x1="11.5" y1="7" x2="16.5" y2="7" stroke="rgba(0,245,255,.4)" stroke-width="1" stroke-linecap="round"/>
            <line x1="11.5" y1="10" x2="16.5" y2="10" stroke="rgba(0,245,255,.4)" stroke-width="1" stroke-linecap="round"/>
            <line x1="11.5" y1="13" x2="16.5" y2="13" stroke="rgba(0,245,255,.25)" stroke-width="1" stroke-linecap="round"/>
            <path d="M5 16C5 22.627 9.477 28 14 28C18.523 28 23 22.627 23 16" stroke="rgba(0,245,255,.85)" stroke-width="1.6" stroke-linecap="round" fill="none"/>
            <line x1="14" y1="28" x2="14" y2="31" stroke="rgba(0,245,255,.85)" stroke-width="1.6" stroke-linecap="round"/>
            <line x1="10" y1="31" x2="18" y2="31" stroke="rgba(0,245,255,.85)" stroke-width="1.8" stroke-linecap="round"/>
            <circle cx="14" cy="4.5" r="1.8" fill="rgba(0,245,255,.7)"/>
          </svg>
          <div class="mic-main-label" id="mic-main-label"></div>
        </div>
      </div>
      <div id="composer-hint">TAP TO WRITE</div>
      <div id="teaser-score-wrap" style="display:flex;align-items:center;justify-content:center;gap:3px;margin-top:10px;">
        <div class="score-hearts-pick" id="new-score-pick"></div>
      </div>
    </div>
    <!-- Expanded: toolbar + input -->
    <div id="composer-expand">
      <div id="comp-toolbar" style="display:none;">
        <img id="comp-img-thumb" src="" alt="">
      </div>
      <div id="comp-text-row">
        <div id="comp-voice-btn" onclick="document.getElementById('fileInput').click()" title="Ê∑ªÂä†ÁÖßÁâá">
          <svg width="18" height="16" viewBox="0 0 18 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="3" width="16" height="12" rx="1.5" stroke="rgba(0,245,255,.8)" stroke-width="1.3"/>
            <circle cx="11" cy="9" r="2.5" stroke="rgba(0,245,255,.8)" stroke-width="1.2"/>
            <path d="M5 6L5 7M5 7L5 8M5 7L4 7M5 7L6 7" stroke="rgba(0,245,255,.8)" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M6.5 3L7.3 1.5H10.7L11.5 3" stroke="rgba(0,245,255,.8)" stroke-width="1.1" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <textarea id="transcript-text" rows="1" placeholder="ÂÜô‰∏ã‰ªäÂ§©ÁöÑÊÄùÁª™..."></textarea>
        <button id="save-btn" onclick="saveEntry()">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 13V3M8 3L4 7M8 3L12 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<div id="feed"></div>

<!-- Calendar panel -->
<div id="cal-panel">
  <div class="cal-header">
    <div class="cal-title-text">// CALENDAR</div>
    <div class="cal-header-right">
      <div class="cal-filter-btn" id="filter-low" onclick="toggleFilter('low')">‰ΩéÂàÜ ‚Üì</div>
      <div class="cal-filter-btn" id="filter-high" onclick="toggleFilter('high')">È´òÂàÜ ‚Üë</div>
      <div class="cal-close" onclick="closeCalendar()">‚úï</div>
    </div>
  </div>
  <div class="cal-body" id="cal-body">
    <div id="score-filter-list" style="display:none;"></div>
    <div id="cal-normal-view">
      <div class="cal-month-nav">
        <button class="cal-nav-btn" onclick="calShift(-1)">‚Äπ</button>
        <div class="cal-month-label" id="cal-month-label"></div>
        <button class="cal-nav-btn" onclick="calShift(1)">‚Ä∫</button>
      </div>
      <div class="cal-grid-wrap">
        <div class="cal-weekdays">
          <div class="cal-wd">Êó•</div><div class="cal-wd">‰∏Ä</div><div class="cal-wd">‰∫å</div>
          <div class="cal-wd">‰∏â</div><div class="cal-wd">Âõõ</div><div class="cal-wd">‰∫î</div><div class="cal-wd">ÂÖ≠</div>
        </div>
        <div class="cal-days" id="cal-days"></div>
      </div>
      <div class="cal-preview" id="cal-preview"></div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" onchange="handleImg(this,'new')">
<input type="file" id="ep-file" accept="image/*" onchange="handleImg(this,'ep')">

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// entries Âú®Â∫ïÈÉ® loadEntries() ‰πãÂâç‰∏∫Á©∫ÔºåÁî± loadEntries Â°´ÂÖÖ
// localStorage ÊåÅ‰πÖÂåñ
const STORAGE_KEY = 'cyberdiary_data';
function getLocalData(){
  try{
    const d = localStorage.getItem(STORAGE_KEY);
    return d ? JSON.parse(d) : null;
  }catch{return null;}
}
function saveLocalData(data){
  try{
    // Â≠òÂÇ®Êó∂ÂéªÊéâimg base64ÔºàÂèØËÉΩÂá†ÂçÅ‰∏áÂ≠óÁ¨¶ÔºâÔºåÈò≤Ê≠¢Ë∂ÖÂá∫localStorage 5MBÈôêÂà∂
    const slim = data.map(e => {
      if(!e.img || e.img.startsWith('http')) return e; // Â§ñÈìæ‰øùÁïô
      const {img, ...rest} = e; // base64ÂéªÊéâ
      return rest;
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(slim));
  }catch(err){
    console.warn('Êú¨Âú∞Â≠òÂÇ®Â§±Ë¥•:', err);
  }
}
let entries = [];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VOICE STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let recognition = null;
let isListening = false;
let listenTarget = 'new'; // 'new' | 'ep' | 'chat'
let finalTranscript = '';
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCORE HEARTS RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// 5È¢óÂøÉÔºöscoreÁõ¥Êé•Â≠ò1-5Ôºå‚â•3È¢ó=È´òÂàÜÔºå<3È¢ó=‰ΩéÂàÜ
function renderHearts(score){
  const filled = Math.min(5, Math.max(1, Math.round(score||3)));
  let h = '';
  for(let i=1;i<=5;i++){
    if(i <= filled) h += '<span>‚ù§Ô∏è</span>';
    else h += '<span style="opacity:.15">ü§ç</span>';
  }
  return h;
}

function scoreLabel(s){
  const hearts = Math.min(5, Math.max(1, Math.round(s||3)));
  if(hearts >= 3) return 'ÂºÄÂøÉ ‚ù§Ô∏è';
  return '‰ΩéËø∑ ü§ç';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BUILD FEED ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let currentMood = 5;
let imgDataUrl = null;
let newScore = 3;

function buildFeed(){
  const feed = document.getElementById('feed');
  feed.innerHTML = '';

  entries.forEach((e,i) => {
    const slide = document.createElement('div');
    slide.className = 'slide';
    slide.dataset.i = i;

    const noc = [['#001a2e','#002a4a','#00f5ff'],['#1a0010','#2e0020','#ff0090'],['#1a1000','#2e1a00','#ffe600']];
    const nc = noc[i%3];

    const sc = e.score||3;
    // Build hearts (1-5 direct score)
    let heartsHtml = '';
    for(let h=1;h<=5;h++){
      const filled = h <= sc;
      heartsHtml += `<span style="font-size:12px;${filled?'':'opacity:.2'}">${filled?'‚ù§Ô∏è':'ü§ç'}</span>`;
    }

    // ÂÖàËÆæÁΩÆ innerHTMLÔºàÈÅøÂÖçÂêéÁª≠ËµãÂÄºË¢´Ë¶ÜÁõñÔºâ
    slide.innerHTML = `
      <div class="slide-grain"></div>
      <div class="slide-scan"></div>
      <div class="slide-vig"></div>
      <div class="slide-border"></div>
      <div class="slide-accent"></div>
      <div class="slide-edit-btn" onclick="openEdit(${i})" style="${e._isWelcome?'display:none':''}">‚úèÔ∏è</div>
      <div class="slide-content">
        <div class="slide-dateline">
          <div class="slide-date">${e.date}</div>
        </div>
        <div class="slide-title" onclick="openDetail(${i})">${e.title}</div>
        <div class="slide-quote">${e.body.length>30?e.body.slice(0,30)+'‚Ä¶':e.body}</div>
        <div class="slide-footer">
          <div class="slide-tags">
            ${e.tags.map(t=>`<span class="stag">${t}</span>`).join('')}
          </div>
        </div>
      </div>`;

    // Âú® innerHTML ‰πãÂêéÂÜçÂ§ÑÁêÜÂõæÁâáËÉåÊôØÔºàÂê¶Âàô‰ºöË¢´Ë¶ÜÁõñÂØºËá¥ÈªëÂ±èÔºâ
    if(e.img){
      const imgSrc = e.img;
      // Áî® Image ÂØπË±°È¢ÑÂä†ËΩΩÔºåÂ§±Ë¥•ÂàôÈôçÁ∫ß‰∏∫Á≤íÂ≠êËÉåÊôØ
      const testImg = new Image();
      testImg.onload = () => {
        slide.style.backgroundImage = 'url(' + imgSrc + ')';
        slide.style.backgroundSize = 'cover';
        slide.style.backgroundPosition = 'center';
      };
      testImg.onerror = () => {
        // ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•ÔºåÈôçÁ∫ß‰∏∫Á≤íÂ≠êËÉåÊôØ
        const np = document.createElement('div');
        np.className = 'slide-nophoto';
        const cv = document.createElement('canvas');
        cv.id = 'pc'+i;
        cv.style.cssText = 'width:100%;height:100%;position:absolute;inset:0;';
        np.appendChild(cv);
        slide.insertBefore(np, slide.firstChild);
        setTimeout(()=>{ if(cv) initParticles(cv, nc[0], nc[1], nc[2]); }, 80);
      };
      testImg.src = imgSrc;
    } else {
      // Êó†ÂõæÁâáÔºåÊèíÂÖ•Á≤íÂ≠êËÉåÊôØ
      const np = document.createElement('div');
      np.className = 'slide-nophoto';
      const cv = document.createElement('canvas');
      cv.id = 'pc'+i;
      cv.style.cssText = 'width:100%;height:100%;position:absolute;inset:0;';
      np.appendChild(cv);
      slide.insertBefore(np, slide.firstChild);
    }

    feed.appendChild(slide);

    if(!e.img){
      setTimeout(()=>{
        const c = document.getElementById('pc'+i);
        if(c) initParticles(c, nc[0], nc[1], nc[2]);
      },80);
    }
  });

  buildDots();
  feed.removeEventListener('scroll', onFeedScroll);
  feed.addEventListener('scroll', onFeedScroll, {passive:true});

  // Tap feed to show composer
  feed.removeEventListener('click', onFeedTap);
  feed.addEventListener('click', onFeedTap);
  updateNavHearts(0);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPOSER SHOW/HIDE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let composerExpanded = false;
let composerVisible = false;
let composerHideTimer = null;

function showComposer(){
  composerVisible = true;
  document.getElementById('composer').classList.add('visible');
  clearTimeout(composerHideTimer);
  // Auto-hide after 4s if not expanded
  composerHideTimer = setTimeout(()=>{
    if(!composerExpanded) hideComposer();
  }, 4000);
}

function hideComposer(){
  if(composerExpanded) return;
  composerVisible = false;
  document.getElementById('composer').classList.remove('visible');
}

function onFeedTap(e){
  // Don't trigger if tapping on interactive elements
  if(e.target.closest('.slide-edit-btn') || e.target.closest('.slide-title')) return;
  if(composerVisible && !composerExpanded){
    hideComposer();
  } else if(!composerVisible){
    showComposer();
  }
}

function handleMicTap(){
  if(isListening && listenTarget==='new'){
    // ÂÅúÊ≠¢ÂΩïÈü≥ ‚Üí doCommitVoice Èáå‰ºö expandComposer
    stopListen();
  } else {
    // Áõ¥Êé•ÂºÄÂßãÂΩïÈü≥Ôºå‰∏çÂ±ïÂºÄ composer
    startVoice('new');
  }
}

function expandComposer(){
  composerExpanded = true;
  clearTimeout(composerHideTimer);
  document.getElementById('composer').classList.add('expanded','visible');
  composerVisible = true;
  setTimeout(()=>{
    const ta = document.getElementById('transcript-text');
    if(ta) ta.focus();
  }, 400);
}

// Auto-resize textarea
document.addEventListener('DOMContentLoaded', ()=>{
  const ta = document.getElementById('transcript-text');
  if(ta){
    ta.addEventListener('input', ()=>{
      ta.style.height = 'auto';
      ta.style.height = Math.min(ta.scrollHeight, 96) + 'px';
    });
  }
});

function collapseComposer(){
  composerExpanded = false;
  document.getElementById('composer').classList.remove('expanded');
  document.getElementById('transcript-text')?.blur();
  hideComposer();
}

// Tap outside to collapse
document.addEventListener('touchstart', (e)=>{
  if(composerExpanded && !document.getElementById('composer').contains(e.target)){
    const txt = document.getElementById('transcript-text');
    if(!txt || !txt.value.trim()) collapseComposer();
  }
},{passive:true});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCORE PICKERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildScorePicker(containerId, currentScore, onPick){
  const c = document.getElementById(containerId);
  if(!c) return;
  c.innerHTML = '';
  for(let i=1;i<=5;i++){
    const s = document.createElement('span');
    s.className = 'shp' + (i <= currentScore ? ' active' : '');
    s.textContent = i <= currentScore ? '‚ù§Ô∏è' : 'ü§ç';
    s.onclick = ()=>{
      onPick(i);
      buildScorePicker(containerId, i, onPick);
    };
    c.appendChild(s);
  }
}

function buildEditScorePicker(score){
  const c = document.getElementById('ep-score-row');
  if(!c) return;
  c.innerHTML = '';
  for(let i=1;i<=5;i++){
    const s = document.createElement('span');
    s.className = 'esp' + (i <= score ? ' active' : '');
    s.textContent = i <= score ? '‚ù§Ô∏è' : 'ü§ç';
    s.onclick = ()=>{
      editScore = i;
      document.getElementById('ep-score-display').textContent = `${i}/5 ¬∑ ${scoreLabel(i)}`;
      buildEditScorePicker(i);
    };
    c.appendChild(s);
  }
}

// Init new entry score picker
buildScorePicker('new-score-pick', 3, v=>{ newScore = v; });
newScore = 3;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARTICLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initParticles(canvas,dark,mid,accent){
  const par = canvas.parentElement;
  canvas.width = par.offsetWidth||window.innerWidth;
  canvas.height = par.offsetHeight||window.innerHeight;
  const ctx = canvas.getContext('2d');
  const g = ctx.createRadialGradient(canvas.width*.5,canvas.height*.4,0,canvas.width*.5,canvas.height*.6,canvas.width*.9);
  g.addColorStop(0,mid); g.addColorStop(1,dark);
  ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
  const pts = Array.from({length:80},()=>({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*1.2+.3,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,a:Math.random()*.5+.15}));
  function draw(){
    ctx.fillStyle='rgba(0,0,0,0.12)'; ctx.fillRect(0,0,canvas.width,canvas.height);
    pts.forEach(p=>{
      ctx.save(); ctx.globalAlpha=p.a; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle=accent; ctx.shadowColor=accent; ctx.shadowBlur=6; ctx.fill(); ctx.restore();
      p.x+=p.vx; p.y+=p.vy;
      if(p.x<0||p.x>canvas.width)p.vx*=-1; if(p.y<0||p.y>canvas.height)p.vy*=-1;
    });
    if(canvas.isConnected) requestAnimationFrame(draw);
  }
  draw();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DOTS + SCROLL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildDots(){
  const w=document.getElementById('dots'); w.innerHTML='';
  for(let i=0;i<entries.length;i++){
    const d=document.createElement('div');
    d.className='dot'+(i===0?' on':'');
    w.appendChild(d);
  }
}

function onFeedScroll(){
  const feed=document.getElementById('feed');
  const idx=Math.round(feed.scrollTop/feed.clientHeight);
  document.querySelectorAll('.dot').forEach((d,i)=>d.classList.toggle('on',i===idx));
  updateNavHearts(idx);
  // Hide composer on scroll
  if(composerVisible && !composerExpanded) hideComposer();
}

function updateNavHearts(idx){
  const e = entries[idx];
  const el = document.getElementById('nav-hearts');
  if(!el) return;
  if(!e){ el.innerHTML=''; return; }
  const sc = Math.min(5, Math.max(1, e.score||3));
  let h = '';
  for(let i=1;i<=5;i++) h += `<span style="font-size:13px;${i<=sc?'':'opacity:.2'}">${i<=sc?'‚ù§Ô∏è':'ü§ç'}</span>`;
  el.innerHTML = h;
  // Êõ¥Êñ∞Âè≥‰∏äËßíÁºñËæëÊåâÈíÆ
  const editBtn = document.getElementById('nav-edit-btn');
  if(editBtn){
    if(e._isWelcome){ editBtn.style.display='none'; }
    else { editBtn.style.display='flex'; editBtn.onclick = ()=>openEdit(idx); }
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VOICE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// Áî®‰∏Ä‰∏™Ê†áÂøó‰ΩçÈò≤Ê≠¢commitVoiceË¢´ÈáçÂ§çË∞ÉÁî®
let voiceCommitted = false;
let interimTranscript = ''; // ÂÆûÊó∂‰∏≠Èó¥ËØÜÂà´ÁªìÊûú

function initRecognition(){
  if(recognition){ try{recognition.abort();}catch(e){} recognition=null; }
  const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR) return null;
  const r = new SR();
  r.lang = 'zh-CN';
  r.continuous = !isIOS;  // iOS‰∏çÊîØÊåÅcontinuousÔºåÈúÄË¶ÅÊâãÂä®restart
  r.interimResults = true;
  r.maxAlternatives = 1;

  r.onresult = (ev)=>{
    let interim='';
    for(let i=ev.resultIndex;i<ev.results.length;i++){
      if(ev.results[i].isFinal) finalTranscript += ev.results[i][0].transcript;
      else interim += ev.results[i][0].transcript;
    }
    interimTranscript = interim; // ÂÆûÊó∂‰øùÂ≠ò‰∏≠Èó¥ÁªìÊûú
    const el = document.getElementById('listen-interim');
    if(el) el.textContent = (finalTranscript+interim)||'...';
    // Â¶ÇÊûúÂ∑≤ÁªèÊèê‰∫§ËøáÔºàÁî®Êà∑ÁÇπ‰∫ÜÂÅúÊ≠¢ÂêéÂºïÊìéËøòÂú®Â§ÑÁêÜÔºâÔºåÈáçÁΩÆÊ†áÂøóËÆ©commitÈáçÊñ∞ÊâßË°å
    if(voiceCommitted && !isListening){
      voiceCommitted = false;
    }
  };

  r.onend = ()=>{
    if(isListening && isIOS){
      // iOSÔºöÁî®Êà∑Ê≤°‰∏ªÂä®ÂÅúÊ≠¢ÔºåÁªßÁª≠ÂΩïÈü≥
      try{ 
        const r2 = initRecognition();
        if(r2){ recognition = r2; r2.start(); }
      }catch(e){}
    } else if(!isListening){
      // Áî®Êà∑‰∏ªÂä®Êåâ‰∫ÜÂÅúÊ≠¢ÔºåÁî±stopListenË¥üË¥£Ë∞ÉÁî®commitVoiceÔºàÂ∑≤Ë∞ÉÁî®ÔºåÊ≠§Â§Ñ‰∏çÈáçÂ§çÔºâ
    } else {
      // ÈùûiOSËá™ÁÑ∂ÁªìÊùüÔºàÂ¶ÇÈùôÈü≥Ë∂ÖÊó∂Ôºâ
      isListening = false;
      doCommitVoice();
    }
  };

  r.onerror = (ev)=>{
    if(ev.error==='not-allowed'||ev.error==='service-not-allowed'){
      isListening = false;
      doCommitVoice();
      showToast('‚ö† ËØ∑Âú®ÊµèËßàÂô®ËÆæÁΩÆ‰∏≠ÂºÄÂêØÈ∫¶ÂÖãÈ£éÊùÉÈôêÂêéÂà∑Êñ∞ÈáçËØï');
      return;
    }
    if((ev.error==='no-speech'||ev.error==='audio-capture') && isIOS && isListening){
      // iOS no-speechÔºåÁªßÁª≠ÈáçËØï
      try{ 
        const r2 = initRecognition();
        if(r2){ recognition = r2; r2.start(); }
      }catch(e){}
    }
  };
  return r;
}

function startVoice(target){
  const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ showToast('ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ÔºåËØ∑ÊâãÂä®ËæìÂÖ•'); return; }

  listenTarget = target;
  finalTranscript = '';
  interimTranscript = '';
  voiceCommitted = false;

  // ‰ª•ÂΩìÂâçËæìÂÖ•Ê°ÜÂÜÖÂÆπ‰Ωú‰∏∫ÂàùÂßãÂÄºÔºàËøΩÂä†Ê®°ÂºèÔºâ
  if(target==='new') finalTranscript = (document.getElementById('transcript-text')||{}).value||'';
  else if(target==='ep') finalTranscript = (document.getElementById('ep-body-input')||{}).value||'';
  else if(target==='chat') finalTranscript = (document.getElementById('dp-chat-input')||{}).value||'';

  recognition = initRecognition();
  if(!recognition) return;

  try{ recognition.start(); }catch(e){ showToast('È∫¶ÂÖãÈ£éÂêØÂä®Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï'); return; }

  isListening = true;
  if(target==='new') document.getElementById('mic-main-btn').classList.add('recording');
  document.getElementById('listen-overlay').classList.add('show');
  document.getElementById('listen-interim').textContent = '...';

  // Âä®ÁîªÊ≥¢ÂΩ¢
  const wv = document.getElementById('listen-wave');
  wv.innerHTML = '';
  for(let i=0;i<20;i++){
    const b=document.createElement('div'); b.className='lw-bar';
    b.style.animationDelay=(i*.06)+'s';
    b.style.animationDuration=(.35+Math.random()*.3)+'s';
    wv.appendChild(b);
  }
}

// ÁúüÊ≠£ÊâßË°åÊèê‰∫§ÁöÑÂáΩÊï∞ÔºåÂÜÖÈÉ®Âä†Èò≤ÈáçÂÖ•‰øùÊä§
function doCommitVoice(){
  if(voiceCommitted) return;   // Èò≤Ê≠¢ÂèåÈáçË∞ÉÁî®
  voiceCommitted = true;

  // ÈöêËóè overlay
  document.getElementById('listen-overlay').classList.remove('show');

  const text = finalTranscript.trim();

  if(listenTarget==='new'){
    document.getElementById('mic-main-btn').classList.remove('recording');
    document.getElementById('comp-voice-btn').classList.remove('recording');
    if(!text) return;
    expandComposer();
    const el = document.getElementById('transcript-text');
    if(el){
      el.value = text;
      el.dispatchEvent(new Event('input'));
      setTimeout(()=>el.focus(), 350);
    }
  } else if(listenTarget==='ep'){
    document.getElementById('ep-mic-btn').classList.remove('recording');
    document.getElementById('ep-mic-lbl').textContent='ÁÇπÂáªÂΩïÈü≥';
    if(!text) return;
    const el=document.getElementById('ep-body-input');
    if(el){ el.value = text; setTimeout(()=>el.focus(), 200); }
  } else if(listenTarget==='chat'){
    document.getElementById('dp-voice-btn').classList.remove('recording');
    if(!text) return;
    const el=document.getElementById('dp-chat-input');
    if(el){ el.value = text; setTimeout(()=>el.focus(), 200); }
  }
}

// ÂÖºÂÆπÊóßË∞ÉÁî®
function commitVoice(){ doCommitVoice(); }

function stopListen(){
  if(!isListening) return;
  isListening = false;  // ÂÖàÁΩÆfalseÔºåÈò≤Ê≠¢onendÈáåÈáçÂêØ
  try{ if(recognition) recognition.stop(); }catch(e){}
  // Á≠â50msËÆ©ÂºïÊìéÊääÁºìÂÜ≤Âå∫ÊúÄÂêé‰∏ÄÂ∏ßonresultÂ§ÑÁêÜÂÆåÔºåÂÜçÂêàÂπ∂interimÊèê‰∫§
  setTimeout(()=>{
    if(interimTranscript.trim()){
      finalTranscript += interimTranscript;
      interimTranscript = '';
    }
    doCommitVoice();
  }, 50);
}

function toggleVoiceForNew(){
  if(isListening && listenTarget==='new'){ stopListen(); return; }
  if(!composerExpanded) expandComposer();
  document.getElementById('comp-voice-btn').classList.add('recording');
  startVoice('new');
}

function toggleVoiceForEdit(){
  if(isListening && listenTarget==='ep'){ stopListen(); return; }
  document.getElementById('ep-mic-btn').classList.add('recording');
  document.getElementById('ep-mic-lbl').textContent = 'ÂΩïÈü≥‰∏≠';
  startVoice('ep');
}

function toggleVoiceForChat(){
  if(isListening && listenTarget==='chat'){ stopListen(); return; }
  document.getElementById('dp-voice-btn').classList.add('recording');
  startVoice('chat');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NEW ENTRY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function handleImg(input, target){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=(ev)=>{
    if(target==='new'){
      imgDataUrl=ev.target.result;
      const thumb=document.getElementById('comp-img-thumb');
      if(thumb){thumb.src=imgDataUrl;thumb.style.display='block';}
      // photo thumbnail shown
    } else {
      epImgDataUrl=ev.target.result;
      const img=document.getElementById('ep-photo-img');
      if(img){img.src=epImgDataUrl;img.style.display='block';}
      const lbl=document.querySelector('.ep-photo-lbl');
      if(lbl) lbl.textContent='ÁÇπÂáªÊõ¥Êç¢ÁÖßÁâá';
    }
  };
  reader.readAsDataURL(file);
}

const API_BASE = 'https://saibo-227257-9-1406038967.sh.run.tcloudbase.com/api';


// ‚îÄ‚îÄ MOCK ÊµãËØïÊó•ËÆ∞ÔºàÊñ∞Áî®Êà∑È¶ñÊ¨°ÊâìÂºÄÂèØËßÅÔºåÂà†Èô§Âêé‰∏çÂÜçÂ§çÁé∞Ôºâ
const MOCK_ENTRIES = [
{
  id: "mock_001",
  title: "Ê≤ôÂú∫‰ΩôÁÉ¨",
  date: "2026.02.20",
  body: "È£ûËàπÊÆãÈ™∏ËøòÂú®ÂáíÁÉüÔºåÊªöÁÉ´ÁöÑÊ∞îÊµÅË£πÁùÄÊ≤ôÁ†æÊâëÈù¢ËÄåÊù•„ÄÇÊàëÁ´ôÂú®ËøôÁâáÁÑ¶Âúü‰∏äÔºåË£ÖÁî≤ÁöÑË£ÇÁºùÈáåÊ∏óÂá∫‰∏Ä‰∏ùÁñºÁóõÔºåÂç¥Ê≤°ÂøÉÊÄùÁÆ°ÂÆÉ„ÄÇ\n\n‰ªªÂä°Â§±Ë¥•‰∫Ü„ÄÇ‰∏çÊòØÂõ†‰∏∫ÂÆûÂäõ‰∏çÂ§üÔºåÊòØÂõ†‰∏∫ÊàëÂú®ÊúÄÂêé‰∏ÄÁßíÂàÜ‰∫ÜÁ•û‚Äî‚ÄîÊàëÊÉ≥Ëµ∑‰∫Ü‰ªñËØ¥ÁöÑÈÇ£Âè•ËØùÔºå„ÄåÊàòÂú∫‰∏äÂèëÂëπÊòØË¶ÅÊ≠ª‰∫∫ÁöÑ„Äç„ÄÇÁªìÊûúËøòÁúüË¢´‰ªñËØ¥‰∏≠‰∫ÜÔºåÂè™ÊòØÊ≠ªÁöÑ‰∏çÊòØÊàëÔºåÊòØÊàëÁöÑÊêûÊ°£„ÄÇ\n\nÁôΩËâ≤ÊàòÁî≤Êüì‰∏äÁöÑË°ÄËøπÊ¥ó‰∏çÊéâÔºåÊàë‰πü‰∏çÊâìÁÆóÊ¥ó„ÄÇÁïôÁùÄÂêßÔºåÁïôÁùÄÊèêÈÜíËá™Â∑±ÔºåÊÑüÊÉÖËøô‰∏úË•øÔºåÊàòÂú∫‰∏äÁúüÁöÑÂ∏¶‰∏ç‰∫Ü„ÄÇ\n\nÂèØÊàëËøòÊòØÊÉ≥‰ªñ„ÄÇÁÉüÈõæÊï£Â∞ΩÔºåËêΩÊó•ÊääËçíÊº†ÁÉßÊàêÊ©òÁ∫¢Ëâ≤ÔºåÂ•ΩÁúãÂæóËÆ©‰∫∫ÊÉ≥Âì≠„ÄÇË¶ÅÊòØ‰ªñÂú®Ôºå‰∏ÄÂÆö‰ºöËØ¥„ÄåËøôÁ†¥Âú∞Êñπ‰πüÂ∞±ËøôÁÇπÂ•ΩÁúãÁöÑ‰∫Ü„ÄçÔºåÁÑ∂ÂêéÊãΩÁùÄÊàëÂæÄÂÆâÂÖ®Âå∫Ë∑ë„ÄÇ\n\nÁé∞Âú®Âè™Ââ©Êàë‰∏Ä‰∏™‰∫∫Á´ôÁùÄÔºåÈ£éÂæàÂ§ß„ÄÇ",
  score: 2,
  tags: ["ÊàòÂú∫", "ËµõÂçö", "Â≠§Áã¨"],
  chats: [],
  img: "mock-001.jpg"
},
{
  id: "mock_002",
  title: "ÈúìËôπÂüéÁöÑÂàÄÂÆ¢",
  date: "2026.02.21",
  body: "‰ªäÂ§©Êé•‰∫Ü‰∏™Â§ßÂçïÔºåÁõÆÊ†áÂú®Á¨¨‰∏ÉÂå∫ÁöÑÈ°∂Â±Ç„ÄÇÈõá‰∏ªËØ¥ÁÆÄÂçïÔºåÊàëËØ¥Â±ÅËØùÔºåÁÆÄÂçïÁöÑÊ¥ªÂÑøËΩÆ‰∏çÂà∞Êàë„ÄÇ\n\nÂ§úÈáåÁà¨‰∏äÂéªÁöÑÊó∂ÂÄôÔºåÊï¥‰∏™ÂüéÂ∏ÇÈÉΩÂú®ÊàëËÑö‰∏ãÂèëÂÖâÔºåÂØÜÂØÜÈ∫ªÈ∫ªÁöÑÈúìËôπÂÉèË∞ÅÊääÊòüÊòüÂÖ®Êëò‰∏ãÊù•Èì∫Âú®Âú∞‰∏ä„ÄÇÁ∫¢ÂàÄÂá∫ÈûòÁöÑÈÇ£‰∏ÄÂàªÔºåÁ©∫Ê∞îÈáåÊúâ‰∏ÄËÇ°ÁÑ¶Á≥äÂë≥ÔºåÈÇ£ÊòØÁ≠âÁ¶ªÂ≠êÂàÉÂíåÊπøÊ∞îÊë©Êì¶ÁöÑÂë≥ÈÅìÔºåÊàëÂñúÊ¨¢Ëøô‰∏™Âë≥ÈÅìÔºåÊúâÁßç"‰ªäÊôöÊúâÊ¥ªÂÑøÂπ≤"ÁöÑËπèÂÆûÊÑü„ÄÇ\n\nÊâìÂÆåÊî∂Â∑•ÔºåÂùêÂú®Â±ãÈ°∂ËæπÁºòÂï§ÁÉ≠ÁãóÔºåÂüéÂ∏ÇÁöÑÂô™Èü≥‰ªé‰∏ãÈù¢Ê∂å‰∏äÊù•Ôºå‰ªÄ‰πàÂè´ÂçñÂ£∞„ÄÅÂºïÊìéÂ£∞„ÄÅÊúâ‰∫∫Âú®Âê∏Êû∂ÔºåÂÖ®ÈÉΩÊ∑∑Âú®‰∏ÄËµ∑„ÄÇÊàëÁöÑÁ∫¢ÂèëË¢´È£éÂêπ‰π±ÔºåÊáíÂæóÊï¥ÁêÜ„ÄÇ\n\nÊúâ‰∫∫ÈóÆÊàëÊÄï‰∏çÊÄïÊ≠ªÔºåÊàëËØ¥‰∏çÊÄïÔºåÊÄïÁöÑÊòØÊ≤°ÊÑèÊÄùÂú∞Ê¥ªÁùÄ„ÄÇËøôÂ∫ßÂüéÂ∏ÇÁªô‰∫ÜÊàëÊÑèÊÄùÔºåÈÇ£Â∞±Â§ü‰∫Ü„ÄÇ\n\nÊòéÂ§©ËøòÊúâÂçïÔºåÁù°‰∫Ü„ÄÇ",
  score: 4,
  tags: ["ËµõÂçöÊúãÂÖã", "Â§úÂüé", "ÂàÄÂÆ¢"],
  chats: [],
  img: "mock-002.jpg"
},
{
  id: "mock_003",
  title: "Âéª‰∫Ü‰∏ÄË∂üÊ≤°Êúâ‰ø°Âè∑ÁöÑÂú∞Êñπ",
  date: "2026.02.22",
  body: "ÊâãÊú∫Ê≤°‰ø°Âè∑ÔºåÂØºËà™Â§±ÁÅµÔºåËøû AI Âä©ÊâãÈÉΩÂú®ËΩ¨ÂúàÂúà„ÄÇ‰ΩÜËØ¥ÂÆûËØùÔºåÈÇ£ÊòØÊàë‰ªäÂπ¥ÊúÄËàíÊúçÁöÑ‰∏ÄÂ§©„ÄÇ\n\nÂ±±ÂæàÈ´òÔºåÁü≥Â§¥ÊòØÁÅ∞ÁªøËâ≤ÁöÑÔºåÂÉèË∞ÅÁî®ÂäõÂæÄÂ§©‰∏äÊàõ‰∫ÜÂá†Ê†πÊâãÊåá„ÄÇÊ∫™Ê∞¥‰ªéÁü≥Â§¥ÁºùÈáåÊå§Âá∫Êù•ÔºåÊ∏ÖÂæóËÉΩÁúãËßÅÂ∫ïÔºåÊúâÊù°Â∞èÈ±ºÊ∏∏ËøáÂéªÔºåÊàëÁ´ôÁùÄÁúã‰∫ÜÂæà‰πÖÔºåÂÆåÂÖ®Âøò‰∫ÜËá™Â∑±Ë¶ÅÂéªÂì™ÂÑø„ÄÇ\n\nÁî∞ÂüÇ‰∏äÊúâ‰∏™ËÄÅ‰∫∫Âú®ÂèëÂëπÔºåÊàë‰πüÂú®ÂèëÂëπÔºå‰∏§‰∏™ÈôåÁîü‰∫∫ÈöîÁùÄ‰∏ÄÊù°Â∞èÊ∫™‰∫íÁõ∏Áúã‰∫Ü‰∏ÄÁúºÔºåÁÑ∂ÂêéÈÉΩËΩ¨ËøáÂ§¥ÁªßÁª≠ÂêÑËá™Âá∫Á•ûÔºåËøôÁßçÈªòÂ•ëËé´ÂêçËÆ©ÊàëËßâÂæóÂæàÊöñ„ÄÇ\n\nÁ®ªÁî∞ÊòØÂ®©ÈªÑÁªøËâ≤ÁöÑÔºåÈ£é‰∏ÄËøáÂ∞±ÂìóÂìóÂìçÔºåÂÉèÊúâ‰∫∫Âú®Â∞èÂ£∞ËØ¥ËØù„ÄÇÊàëÁ™ÅÁÑ∂ËßâÂæóÔºå‰∫∫Ë¶ÅÊòØËÉΩÂÉèËøôÊ£µÁ®ªÂ≠ê‰∏ÄÊ†∑Ôºå‰∏çÁÆ°‰∏ñÁïåÂ§ö‰π±ÔºåÂè™ÁÆ°ÂæÄ‰∏äÈïøÔºå‰πüÊå∫Â•ΩÁöÑ„ÄÇ\n\nÂõûÊù•‰ª•ÂêéÂºÄ‰∫Ü‰∏ÄÂ§©ÁöÑ‰ºöÔºå‰ΩÜÁúºÂâç‰∏ÄÁõ¥ÊúâÈÇ£Êù°Ê∫™„ÄÇ",
  score: 5,
  tags: ["Ëá™ÁÑ∂", "Âá∫Ëµ∞", "Ê≤ªÊÑà"],
  chats: [],
  img: "mock-003.jpg"
}
];

// ‚îÄ‚îÄ Ê¨¢ËøéÊó•ËÆ∞Â∏∏ÈáèÔºàÂÜÖÁΩÆÔºå‰∏çËµ∞APIÔºâ
const WELCOME_ID = '__welcome__';
const WELCOME_ENTRY = {
  id: WELCOME_ID,
  title: 'Êù•ÂòõÔºå‰πñ‰πñÂÜôÊó•ËÆ∞ÂíØÔºÅ',
  date: '2026.02.25',
  body: 'Êú™Êù•Â∑≤Êù•ÔºåÊ¨¢Ëøé‰Ω†ÁöÑÂà∞Êù•Ôºå‰∏ÄËµ∑ËÆ∞ÂΩïÂ±û‰∫é‰Ω†ÁöÑËµõÂçöÊó•ËÆ∞ÂêßÔºÅcome on gogogoÔºÅ',
  score: 10,
  tags: ['Ê¨¢Ëøé', 'ËµõÂçö'],
  img: 'welcome-bg.jpg',
  chats: [],
  _isWelcome: true
};

function ensureWelcomeEntry(list) {
  // ËØªÂèñÁî®Êà∑Â∑≤Âà†Èô§ÁöÑ mock idÔºàlocalStorage ÈªëÂêçÂçïÔºâ
  const deletedMocks = JSON.parse(localStorage.getItem('deleted_mocks') || '[]');
  // Ê¨¢ËøéÊó•ËÆ∞ÂßãÁªàÊéíÂú®ÊúÄÂêé‰∏ÄÊù°ÔºåmockÊï∞ÊçÆÊèíÂú®ÊúÄÂâç
  const filtered = list.filter(e => e.id !== WELCOME_ID && !e._isWelcome);
  // ËøáÊª§ÊéâÂ∑≤Â≠òÂú®ÁöÑmockÔºàÈÅøÂÖçÈáçÂ§çÔºâ
  const withoutMock = filtered.filter(e => !e.id.startsWith('mock_'));
  const mockFiltered = MOCK_ENTRIES.filter(m =>
    !filtered.some(e => e.id === m.id) &&
    !deletedMocks.includes(m.id)  // Áî®Êà∑Â∑≤Âà†Èô§ÁöÑ‰∏çÂÜçÂ§çÁé∞
  );
  return [...withoutMock, ...mockFiltered, WELCOME_ENTRY];
}

// ‰ªéÂêéÁ´ØÂä†ËΩΩÊó•ËÆ∞
// Á≠ñÁï•ÔºöÁ´ãÂàªÂÖàÊòæÁ§∫Ê¨¢ËøéÊó•ËÆ∞ÔºåÂêåÊó∂ÂêéÂè∞ËØ∑Ê±ÇAPIÂêàÂπ∂ÁúüÂÆûÊï∞ÊçÆÔºå5ÁßíË∂ÖÊó∂
async function loadEntries() {
  // ‚ë† ÂÖà‰ªé localStorage Âä†ËΩΩ
  const local = getLocalData();
  if(local && Array.isArray(local) && local.length > 0){
    entries = ensureWelcomeEntry(local);
    buildFeed();
  }else{
    entries = ensureWelcomeEntry([]);
    buildFeed();
  }

  // ‚ë° ÂêéÂè∞Â∞ùËØï‰ªéAPIÊãâÂèñÁúüÂÆûÊó•ËÆ∞Ôºà5ÁßíË∂ÖÊó∂Ôºâ
  try {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), 5000);
    const res = await fetch(`${API_BASE}/diaries`, { signal: controller.signal });
    clearTimeout(timer);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if(Array.isArray(data)){
      // ÂêàÂπ∂Á≠ñÁï•ÔºöAPIÊï∞ÊçÆ‰∏∫‰∏ªÔºå‰ΩÜÂ¶ÇÊûúAPIËøîÂõûÁ©∫ËÄåÊú¨Âú∞ÊúâÊï∞ÊçÆÔºå‰øùÁïôÊú¨Âú∞
      const local = getLocalData();
      if(data.length === 0 && local && local.length > 0){
        console.log('APIËøîÂõûÁ©∫Ôºå‰øùÁïôÊú¨Âú∞Êï∞ÊçÆ');
      } else {
        entries = ensureWelcomeEntry(data);
        saveLocalData(entries);
        buildFeed();
      }
    }
  } catch(e) {
    if (e.name !== 'AbortError') {
      console.log('ÂêéÁ´ØÊöÇ‰∏çÂèØÁî®Ôºå‰ΩøÁî®Êú¨Âú∞Êï∞ÊçÆ');
    }
  }
}
// ÂéãÁº©ÂõæÁâáÂà∞ÈÄÇÂêà‰∏ä‰º†ÁöÑÂ§ßÂ∞èÔºàÊúÄÂ§ß200KB base64Ôºâ
async function compressImg(dataUrl, maxBytes=200000){
  if(!dataUrl) return null;
  if(dataUrl.length <= maxBytes) return dataUrl;
  return new Promise(resolve=>{
    const img = new window.Image();
    img.onload = ()=>{
      let w=img.width, h=img.height;
      // Á≠âÊØîÁº©Â∞è
      const scale = Math.sqrt(maxBytes / dataUrl.length);
      w = Math.floor(w * scale);
      h = Math.floor(h * scale);
      const cv = document.createElement('canvas');
      cv.width=w; cv.height=h;
      cv.getContext('2d').drawImage(img,0,0,w,h);
      // Â∞ùËØï‰∏çÂêåquality
      let q=0.75;
      let result = cv.toDataURL('image/jpeg', q);
      while(result.length > maxBytes && q > 0.3){
        q -= 0.1;
        result = cv.toDataURL('image/jpeg', q);
      }
      resolve(result.length <= maxBytes ? result : null);
    };
    img.onerror = ()=>resolve(null);
    img.src = dataUrl;
  });
}

// ‰øùÂ≠òÊó•ËÆ∞Âà∞ÂêéÁ´Ø
async function saveEntry(){
  const text=(document.getElementById('transcript-text').value||'').trim();
  if(!text){ showToast('ËØ∑ÂÖàËæìÂÖ•ÂÜÖÂÆπ ‚ú¶'); return; }

  // ÊòæÁ§∫‰øùÂ≠ò‰∏≠
  const saveBtn = document.getElementById('save-btn');
  if(saveBtn){ saveBtn.disabled=true; saveBtn.textContent='‚Ä¶'; }

  const now=new Date();
  const ds=`${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
  const fc=text.replace(/[Ôºå„ÄÇÔºÅÔºü,.!?\n]/,'¬ß').split('¬ß')[0].slice(0,14);

  // ÂéãÁº©ÂõæÁâá
  const compressedImg = await compressImg(imgDataUrl);

  try {
    const res = await fetch(`${API_BASE}/diaries`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        title: fc || '‰ªäÊó•ËÆ∞ÂΩï',
        date: ds,
        body: text,
        score: newScore,
        tags: ['Êó•ËÆ∞'],
        img: compressedImg || null
      })
    });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const newDiary = await res.json();
    entries = ensureWelcomeEntry([newDiary, ...entries.filter(e=>!e._isWelcome)]);
    saveLocalData(entries);
  } catch(e) {
    console.error('‰øùÂ≠òÂ§±Ë¥•:', e);
    // Êú¨Âú∞‰∏¥Êó∂‰øùÂ≠ò
    const localEntry = {
      id: 'local_'+Date.now(),
      title: fc||'‰ªäÊó•ËÆ∞ÂΩï', date:ds, body:text,
      score:newScore, tags:['Êó•ËÆ∞'],
      img: compressedImg||null, chats:[], _local:true
    };
    entries = ensureWelcomeEntry([localEntry, ...entries.filter(e=>!e._isWelcome)]);
    saveLocalData(entries);
    showToast('‚ö† ÁΩëÁªúÂºÇÂ∏∏ÔºåÂ∑≤Êú¨Âú∞‰øùÂ≠òÔºåÁ®çÂêéÂèØÈáçÊñ∞Êèê‰∫§');
    // ‰ªçÁÑ∂ÁªßÁª≠ÊµÅÁ®ã‰∏çreturn
  } finally {
    if(saveBtn){ saveBtn.disabled=false; saveBtn.textContent='‚Üë'; }
  }

  document.getElementById('transcript-text').value='';
  finalTranscript=''; imgDataUrl=null;
  const thumb=document.getElementById('comp-img-thumb');
  if(thumb){thumb.style.display='none';thumb.src='';}
  document.getElementById('fileInput').value='';
  newScore=3;
  buildScorePicker('new-score-pick',3,v=>{ newScore=v; });

  collapseComposer();
  buildFeed();
  showToast('‚úì ÂíîÔΩûËµõÂçöÊó•ÂøóÊâìÂç°ÊàêÂäüÔºÅ');
  setTimeout(()=>document.getElementById('feed').scrollTo({top:0,behavior:'smooth'}),350);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETAIL PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let detailIdx = null;

function openDetail(idx){
  detailIdx = idx;
  const e = entries[idx];

  // Cover
  const cw = document.getElementById('dp-cover-wrap');
  if(e.img){
    cw.innerHTML = `<img class="dp-cover" src="${e.img}" alt="">`;
  } else {
    cw.innerHTML = `<div class="dp-cover-none"></div>`;
  }

  document.getElementById('dp-date').textContent = e.date;
  document.getElementById('dp-title').textContent = e.title;

  const sc = e.score||5;
  document.getElementById('dp-score-hearts').innerHTML = renderHearts(sc);
  document.getElementById('dp-score-label').textContent = '';
  document.getElementById('dp-tags').innerHTML = (e.tags||[]).map(t=>`<span class="stag">${t}</span>`).join('');
  document.getElementById('dp-body-text').textContent = e.body;

  renderChatLog(e.chats||[]);
  document.getElementById('dp-chat-input').value = '';
  document.getElementById('dp-scroll').scrollTop = 0;
  document.getElementById('detail-panel').classList.add('show');
  // Hide composer behind detail
  hideComposer();
}

function closeDetail(){
  document.getElementById('detail-panel').classList.remove('show');
  detailIdx = null;
}

function openEditFromDetail(){
  const idx = detailIdx;
  closeDetail();
  setTimeout(()=>openEdit(idx), 100);
}

function renderChatLog(chats){
  const log = document.getElementById('chat-log');
  if(!chats||!chats.length){ log.innerHTML='<div style="font-family:\'Share Tech Mono\',monospace;font-size:10px;color:rgba(255,255,255,.18);letter-spacing:2px;text-align:center;padding:16px 0;">// ËøòÊ≤°ÊúâÂØπËØùÔºåÂºÄÂßãËÅäËÅäËøôÁØáÊó•ËÆ∞Âêß</div>'; return; }
  log.innerHTML = chats.map(c=>`
    <div class="chat-msg ${c.role}">
      <div class="chat-bubble">${c.text}</div>
      <div class="chat-time">${c.time||''}</div>
    </div>`).join('');
  // Scroll to bottom after render
  setTimeout(()=>{ const b=document.getElementById('dp-scroll'); if(b) b.scrollTop=b.scrollHeight; },100);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI CHAT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function sendChat(){
  if(detailIdx===null) return;
  const input = document.getElementById('dp-chat-input');
  const text = (input.value||'').trim();
  if(!text) return;
  input.value='';

  const e = entries[detailIdx];
  if(!e.chats) e.chats=[];

  const now = new Date();
  const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

  // Add user message
  e.chats.push({role:'user', text, time:timeStr});
  renderChatLog(e.chats);

  // Show thinking
  const log = document.getElementById('chat-log');
  const thinkEl = document.createElement('div');
  thinkEl.className='chat-msg ai';
  thinkEl.innerHTML='<div class="chat-bubble"><span class="chat-thinking">AI ÊÄùËÄÉ‰∏≠...</span></div>';
  log.appendChild(thinkEl);
  document.getElementById('dp-scroll').scrollTop = document.getElementById('dp-scroll').scrollHeight;

  // Build context
  const context = `ËøôÊòØÁî®Êà∑ÁöÑ‰∏ÄÁØáÊó•ËÆ∞Ôºö
Ê†áÈ¢òÔºö${e.title}
Êó•ÊúüÔºö${e.date}
ÂÜÖÂÆπÔºö${e.body}
ÂøÉÊÉÖËØÑÂàÜÔºö${e.score||3}/5`;

  const history = e.chats.slice(0,-1).map(c=>({
    role: c.role==='user'?'user':'assistant',
    content: c.text
  }));

  try{
    // Ë∞ÉÁî®Êú¨Âú∞ÂêéÁ´Ø AI API (ÊâãÊú∫ËÆøÈóÆÁî® IP)
    const res = await fetch(`${API_BASE}/chat`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        diary: { title: e.title, date: e.date, body: e.body, score: e.score },
        message: text,
        history: history
      })
    });
    const data = await res.json();
    const reply = data.reply || 'Êä±Ê≠âÔºåÊàëÊöÇÊó∂Êó†Ê≥ïÂõûÂ∫îÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ';
    thinkEl.remove();
    e.chats.push({role:'ai', text:reply, time:timeStr});
    // ‰øùÂ≠òÂØπËØùÂà∞ÂêéÁ´Ø
    fetch(`${API_BASE}/diaries/${e.id}/chats`, {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ chats: e.chats })
    });
    renderChatLog(e.chats);
  } catch(err){
    thinkEl.remove();
    const errMsg = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï„ÄÇ';
    e.chats.push({role:'ai', text:errMsg, time:timeStr});
    renderChatLog(e.chats);
  }
}

// Enter key sends chat
document.getElementById('dp-chat-input').addEventListener('keydown',e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let editingIdx = null;
let editScore = 3;
let epImgDataUrl = null;

function openEdit(idx){
  const e = entries[idx];
  if(e._isWelcome){
    showToast('Ê¨¢ËøéÊó•ËÆ∞‰∏çÂèØÁºñËæëÂì¶ ‚ú®');
    return;
  }
  editingIdx = idx;
  document.getElementById('ep-date-row').textContent = e.date;
  document.getElementById('ep-title-input').value = e.title;
  document.getElementById('ep-body-input').value = e.body;
  document.getElementById('ep-tags-input').value = (e.tags||[]).join(' ');

  const img=document.getElementById('ep-photo-img');
  const lbl=document.querySelector('.ep-photo-lbl');
  if(e.img){
    img.src=e.img;img.style.display='block';epImgDataUrl=e.img;
    if(lbl) lbl.textContent='ÁÇπÂáªÊõ¥Êç¢ÁÖßÁâá';
  } else {
    img.style.display='none';img.src='';epImgDataUrl=null;
    if(lbl) lbl.textContent='ÁÇπÂáªÊ∑ªÂä†ÁÖßÁâá';
  }

  editScore = e.score||3;
  document.getElementById('ep-score-display').textContent = `${editScore}/5 ¬∑ ${scoreLabel(editScore)}`;
  buildEditScorePicker(editScore);

  document.getElementById('ep-body').scrollTop=0;
  document.getElementById('edit-panel').classList.add('show');
}

function closeEdit(){
  document.getElementById('edit-panel').classList.remove('show');
  editingIdx=null;
  document.getElementById('ep-file').value='';
  if(isListening && listenTarget==='ep') stopListen();
}

function saveEdit(){
  if(editingIdx===null) return;
  const e = entries[editingIdx];
  const title=(document.getElementById('ep-title-input').value||'').trim();
  const body=(document.getElementById('ep-body-input').value||'').trim();
  const tagsRaw=(document.getElementById('ep-tags-input').value||'').trim();
  const tags=tagsRaw?tagsRaw.split(/\s+/).filter(Boolean):['Êó•ËÆ∞'];
  if(!body){ showToast('Ê≠£Êñá‰∏çËÉΩ‰∏∫Á©∫ ‚ú¶'); return; }

  const updated = {
    ...e,
    title:title||e.title,
    body, tags,
    score:editScore,
    img:epImgDataUrl||null,
  };

  // Ë∞ÉÁî®ÂêéÁ´ØÊõ¥Êñ∞ÔºàÂ∏¶ÂõæÁâáÂéãÁº©Ôºâ
  compressImg(updated.img).then(compImg=>{
    const toSend = {...updated, img: compImg||null};
    fetch(`${API_BASE}/diaries/${e.id}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(toSend)
    }).then(r=>{
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      entries[editingIdx] = {...updated, img: compImg||null};
      closeEdit();
      buildFeed();
      showToast('‚úì ‰øÆÊîπÂ∑≤‰øùÂ≠ò');
    }).catch(()=>{
      // Êú¨Âú∞‰øùÂ≠ò
      entries[editingIdx] = {...updated, img: compImg||null};
      closeEdit();
      buildFeed();
      showToast('‚ö† ÁΩëÁªúÂºÇÂ∏∏ÔºåÂ∑≤Êú¨Âú∞ÊöÇÂ≠ò');
    });
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DELETE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function confirmDelete(){ document.getElementById('del-confirm').classList.add('show'); }
function doDelete(){
  document.getElementById('del-confirm').classList.remove('show');
  if(editingIdx===null) return;
  const e = entries[editingIdx];
  
  // Ë∞ÉÁî®ÂêéÁ´ØÂà†Èô§
  // Â¶ÇÊûúÊòØ mock Êó•ËÆ∞ÔºåËÆ∞ÂΩïÂà∞ localStorage ÈªëÂêçÂçïÔºåÂà∑Êñ∞Âêé‰∏çÂÜçÂ§çÁé∞
  if(e.id.startsWith('mock_')) {
    const deletedMocks = JSON.parse(localStorage.getItem('deleted_mocks') || '[]');
    if(!deletedMocks.includes(e.id)) deletedMocks.push(e.id);
    localStorage.setItem('deleted_mocks', JSON.stringify(deletedMocks));
    entries.splice(editingIdx,1);
    saveLocalData(entries);
    closeEdit();
    buildFeed();
    showToast('Êó•ËÆ∞Â∑≤Âà†Èô§');
    return;
  }

  fetch(`${API_BASE}/diaries/${e.id}`, {
    method: 'DELETE'
  }).then(() => {
    entries.splice(editingIdx,1);
    saveLocalData(entries);
    closeEdit();
    buildFeed();
    showToast('Êó•ËÆ∞Â∑≤Âà†Èô§');
  }).catch(() => {
    showToast('Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CALENDAR + SCORE FILTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let calYear=new Date().getFullYear(), calMonth=new Date().getMonth(), calSelected=null;
let activeFilter=null; // 'high' | 'low' | null

function openCalendar(){
  calYear=new Date().getFullYear(); calMonth=new Date().getMonth();
  calSelected=null; activeFilter=null;
  document.getElementById('filter-high').classList.remove('on2');
  document.getElementById('filter-low').classList.remove('on');
  document.getElementById('score-filter-list').style.display='none';
  document.getElementById('cal-normal-view').style.display='';
  renderCalendar();
  document.getElementById('cal-panel').classList.add('show');
}

function closeCalendar(){ document.getElementById('cal-panel').classList.remove('show'); }
function calShift(dir){
  calMonth+=dir;
  if(calMonth<0){calMonth=11;calYear--;}
  if(calMonth>11){calMonth=0;calYear++;}
  renderCalendar();
}

function toggleFilter(type){
  if(activeFilter===type){
    activeFilter=null;
    document.getElementById('filter-high').classList.remove('on2');
    document.getElementById('filter-low').classList.remove('on');
    document.getElementById('score-filter-list').style.display='none';
    document.getElementById('cal-normal-view').style.display='';
    return;
  }
  activeFilter=type;
  document.getElementById('filter-high').classList.toggle('on2', type==='high');
  document.getElementById('filter-low').classList.toggle('on', type==='low');
  document.getElementById('cal-normal-view').style.display='none';
  renderScoreList(type);
  document.getElementById('score-filter-list').style.display='';
}

function renderScoreList(type){
  // scoreÁõ¥Êé•Â≠ò1-5Ôºå3È¢óÂèä‰ª•‰∏ä=È´òÂàÜÔºå3È¢ó‰ª•‰∏ã=‰ΩéÂàÜ
  const filtered = entries.filter(e => {
    const sc = Math.min(5, Math.max(1, e.score || 3));
    return type === 'high' ? sc >= 3 : sc < 3;
  });
  const sorted = [...filtered].sort((a,b)=>{
    if (a.date !== b.date) return b.date.localeCompare(a.date);
    return type === 'high' ? (b.score||3) - (a.score||3) : (a.score||3) - (b.score||3);
  });
  const container=document.getElementById('score-filter-list');
  container.innerHTML = `<div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.3);letter-spacing:2px;margin-bottom:14px;">${type==='high'?'// ÂºÄÂøÉÁöÑÊó•ËÆ∞ ‚ù§Ô∏è (3È¢óÂøÉÂèä‰ª•‰∏ä)':'// ‰∏çÂºÄÂøÉÁöÑÊó•ËÆ∞ ü§ç (3È¢óÂøÉ‰ª•‰∏ã)'}</div>`;
  if(!sorted.length){
    container.innerHTML += `<div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.2);letter-spacing:2px;text-align:center;padding:32px 0;">ÊöÇÊó†ËÆ∞ÂΩï</div>`;
    return;
  }
  sorted.forEach(e=>{
    const idx=entries.indexOf(e);
    const sc=Math.min(5, Math.max(1, e.score||3));
    let hearts='';
    for(let i=1;i<=5;i++) hearts+=`<span style="font-size:11px;${i<=sc?'':'opacity:.2'}">${i<=sc?'‚ù§Ô∏è':'ü§ç'}</span>`;
    const card=document.createElement('div');
    card.className='sfl-card';
    card.innerHTML=`<div class="sfl-row"><div class="sfl-title">${e.title}</div><div class="sfl-hearts">${hearts}</div></div>
    <div class="sfl-date">${e.date}</div>
    <div class="sfl-body">${e.body}</div>`;
    card.onclick=()=>{ closeCalendar(); setTimeout(()=>openDetail(idx),200); };
    container.appendChild(card);
  });
}

function renderCalendar(){
  const months=['‰∏ÄÊúà','‰∫åÊúà','‰∏âÊúà','ÂõõÊúà','‰∫îÊúà','ÂÖ≠Êúà','‰∏ÉÊúà','ÂÖ´Êúà','‰πùÊúà','ÂçÅÊúà','ÂçÅ‰∏ÄÊúà','ÂçÅ‰∫åÊúà'];
  document.getElementById('cal-month-label').textContent=`${calYear} ¬∑ ${months[calMonth]}`;
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const today=new Date();
  const todayStr=`${today.getFullYear()}.${String(today.getMonth()+1).padStart(2,'0')}.${String(today.getDate()).padStart(2,'0')}`;
  const entryDates=new Set(entries.map(e=>e.date));
  const grid=document.getElementById('cal-days');
  grid.innerHTML='';
  for(let i=0;i<firstDay;i++){const c=document.createElement('div');c.className='cal-day empty';grid.appendChild(c);}
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${calYear}.${String(calMonth+1).padStart(2,'0')}.${String(d).padStart(2,'0')}`;
    const has=entryDates.has(ds), isT=ds===todayStr, isSel=ds===calSelected;
    const cell=document.createElement('div');
    cell.className='cal-day'+(has?' has-entry':'')+(isT?' today':'')+(isSel?' selected':'');
    cell.innerHTML=`<div class="cal-day-num">${d}</div>${has&&!isSel?'<div class="cal-day-dot"></div>':''}`;
    cell.onclick=()=>{ calSelected=calSelected===ds?null:ds; renderCalendar(); };
    grid.appendChild(cell);
  }
  renderCalPreview();
}

function renderCalPreview(){
  const preview=document.getElementById('cal-preview');
  if(!calSelected){preview.innerHTML='';return;}
  const dayEntries=entries.filter(e=>e.date===calSelected);
  const parts=calSelected.split('.');
  const label=`${parts[0]}Âπ¥${Number(parts[1])}Êúà${Number(parts[2])}Êó•`;
  let html=`<div class="cal-preview-date">// ${label}</div>`;
  if(!dayEntries.length){html+=`<div class="cal-no-entry">ËøôÂ§©Ê≤°ÊúâÊó•ËÆ∞</div>`;}
  else{
    dayEntries.forEach(e=>{
      const idx=entries.indexOf(e);
      const sc=Math.min(5, Math.max(1, e.score||3));
      let hearts='';
      for(let i=1;i<=5;i++) hearts+=`<span style="font-size:11px;${i<=sc?'':'opacity:.2'}">${i<=sc?'‚ù§Ô∏è':'ü§ç'}</span>`;
      html+=`<div class="cal-entry-card" onclick="closeCalendar();setTimeout(()=>openDetail(${idx}),200)">
        <div class="cal-entry-title">${e.title}</div>
        <div class="cal-entry-body">${e.body}</div>
        <div class="cal-entry-meta">${hearts}</div>
      </div>`;
    });
  }
  preview.innerHTML=html;
}

function goToEntry(idx){
  closeCalendar();
  setTimeout(()=>{
    const feed=document.getElementById('feed');
    feed.scrollTo({top:idx*feed.clientHeight,behavior:'smooth'});
  },300);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function goFeed(){ document.getElementById('feed').scrollTo({top:0,behavior:'smooth'}); collapseComposer(); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';
  clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',3000);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
loadEntries(); // API_BASEÂ∑≤ÂÆö‰πâÔºåÂÆâÂÖ®Ë∞ÉÁî®
</script>
</body>
</html>



